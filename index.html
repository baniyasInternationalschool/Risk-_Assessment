<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baniyas International School - Professional Risk Assessment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- FileSaver.js for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <!-- jsPDF for PDF export with Arabic support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4c4cb8',
                        'high-risk': '#ef4444',
                        'medium-risk': '#f97316',
                        'low-risk': '#22c55e',
                        'high-risk-bg': 'rgba(239, 68, 68, 0.15)',
                        'medium-risk-bg': 'rgba(249, 115, 22, 0.15)',
                        'low-risk-bg': 'rgba(34, 197, 94, 0.15)',
                    },
                    boxShadow: {
                        'custom': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'custom-dark': '0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.12)',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
        }
        
        [dir="rtl"] body {
            font-family: 'Cairo', sans-serif;
        }
        
        .risk-high {
            background-color: rgba(239, 68, 68, 0.15);
            border-left: 4px solid #ef4444;
        }
        
        [dir="rtl"] .risk-high {
            border-left: none;
            border-right: 4px solid #ef4444;
        }
        
        .risk-medium {
            background-color: rgba(249, 115, 22, 0.15);
            border-left: 4px solid #f97316;
        }
        
        [dir="rtl"] .risk-medium {
            border-left: none;
            border-right: 4px solid #f97316;
        }
        
        .risk-low {
            background-color: rgba(34, 197, 94, 0.15);
            border-left: 4px solid #22c55e;
        }
        
        [dir="rtl"] .risk-low {
            border-left: none;
            border-right: 4px solid #22c55e;
        }
        
        .dark .risk-high {
            background-color: rgba(239, 68, 68, 0.2);
        }
        
        .dark .risk-medium {
            background-color: rgba(249, 115, 22, 0.2);
        }
        
        .dark .risk-low {
            background-color: rgba(34, 197, 94, 0.2);
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chip {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 4px;
            margin-bottom: 4px;
            display: inline-block;
            white-space: nowrap;
        }
        
        [dir="rtl"] .chip {
            margin-right: 0;
            margin-left: 4px;
        }
        
        .chip-children {
            background-color: rgba(59, 130, 246, 0.2);
            color: rgb(29, 78, 216);
        }
        
        .chip-teachers {
            background-color: rgba(139, 92, 246, 0.2);
            color: rgb(109, 40, 217);
        }
        
        .chip-staff {
            background-color: rgba(234, 88, 12, 0.2);
            color: rgb(194, 65, 12);
        }
        
        .chip-others {
            background-color: rgba(107, 114, 128, 0.2);
            color: rgb(55, 65, 81);
        }
        
        .chip-everyone {
            background-color: rgba(220, 38, 38, 0.2);
            color: rgb(185, 28, 28);
        }
        
        .dark .chip-children {
            background-color: rgba(59, 130, 246, 0.3);
            color: rgb(147, 197, 253);
        }
        
        .dark .chip-teachers {
            background-color: rgba(139, 92, 246, 0.3);
            color: rgb(196, 181, 253);
        }
        
        .dark .chip-staff {
            background-color: rgba(234, 88, 12, 0.3);
            color: rgb(254, 215, 170);
        }
        
        .dark .chip-others {
            background-color: rgba(107, 114, 128, 0.3);
            color: rgb(209, 213, 219);
        }
        
        .dark .chip-everyone {
            background-color: rgba(220, 38, 38, 0.3);
            color: rgb(254, 202, 202);
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #5D5CDE;
            animation: spin 1s ease infinite;
            margin: 0 auto;
        }
        
        [dir="rtl"] .spinner {
            border-left-color: rgba(0, 0, 0, 0.1);
            border-right-color: #5D5CDE;
        }
        
        .dark .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-left-color: #5D5CDE;
        }
        
        [dir="rtl"] .dark .spinner {
            border-left-color: rgba(255, 255, 255, 0.1);
            border-right-color: #5D5CDE;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #bbb;
            border-radius: 4px;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: #4a5568;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        /* Professional Table styles */
        .assessment-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .assessment-table th {
            text-align: left;
            padding: 16px 12px;
            background: linear-gradient(135deg, #5D5CDE 0%, #4c4cb8 100%);
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: none;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        [dir="rtl"] .assessment-table th {
            text-align: right;
        }
        
        .dark .assessment-table {
            border: 1px solid #374151;
        }
        
        .assessment-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: top;
            background-color: #ffffff;
            transition: all 0.2s ease;
        }
        
        .dark .assessment-table td {
            border-bottom: 1px solid #374151;
            background-color: #1f2937;
        }
        
        .assessment-table tr:hover td {
            background-color: #f8fafc;
            transform: scale(1.01);
        }
        
        .dark .assessment-table tr:hover td {
            background-color: #374151;
        }
        
        .assessment-table tr:last-child td {
            border-bottom: none;
        }

        /* Risk level badges */
        .risk-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .risk-badge-high {
            background-color: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .risk-badge-medium {
            background-color: #fed7aa;
            color: #ea580c;
            border: 1px solid #fdba74;
        }
        
        .risk-badge-low {
            background-color: #dcfce7;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }
        
        .dark .risk-badge-high {
            background-color: rgba(220, 38, 38, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(220, 38, 38, 0.3);
        }
        
        .dark .risk-badge-medium {
            background-color: rgba(234, 88, 12, 0.2);
            color: #fdba74;
            border: 1px solid rgba(234, 88, 12, 0.3);
        }
        
        .dark .risk-badge-low {
            background-color: rgba(22, 163, 74, 0.2);
            color: #86efac;
            border: 1px solid rgba(22, 163, 74, 0.3);
        }

        /* Action buttons */
        .action-btn {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            margin-right: 4px;
        }
        
        [dir="rtl"] .action-btn {
            margin-right: 0;
            margin-left: 4px;
        }
        
        .action-btn-view {
            background-color: #eff6ff;
            color: #2563eb;
            border-color: #dbeafe;
        }
        
        .action-btn-view:hover {
            background-color: #dbeafe;
            color: #1d4ed8;
        }
        
        .action-btn-edit {
            background-color: #f0fdf4;
            color: #16a34a;
            border-color: #dcfce7;
        }
        
        .action-btn-edit:hover {
            background-color: #dcfce7;
            color: #15803d;
        }
        
        .action-btn-delete {
            background-color: #fef2f2;
            color: #dc2626;
            border-color: #fecaca;
        }
        
        .action-btn-delete:hover {
            background-color: #fecaca;
            color: #b91c1c;
        }
        
        .dark .action-btn-view {
            background-color: rgba(37, 99, 235, 0.2);
            color: #93c5fd;
            border-color: rgba(37, 99, 235, 0.3);
        }
        
        .dark .action-btn-edit {
            background-color: rgba(22, 163, 74, 0.2);
            color: #86efac;
            border-color: rgba(22, 163, 74, 0.3);
        }
        
        .dark .action-btn-delete {
            background-color: rgba(220, 38, 38, 0.2);
            color: #fca5a5;
            border-color: rgba(220, 38, 38, 0.3);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fff;
            border-radius: 0.5rem;
            padding: 1.5rem;
            max-width: 90%;
            width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .modal-content-lg {
            width: 800px;
            max-width: 95%;
        }

        .dark .modal-content {
            background-color: #1F2937;
            color: #F9FAFB;
        }
        
        /* Responsive table */
        @media (max-width: 768px) {
            .responsive-table {
                overflow-x: auto;
            }
            
            .responsive-table::-webkit-scrollbar {
                height: 6px;
            }
            
            .assessment-table th,
            .assessment-table td {
                padding: 12px 8px;
                font-size: 0.8rem;
            }
            
            .action-btn {
                padding: 6px 8px;
                font-size: 0.7rem;
            }
        }
        
        /* Logo upload styles */
        .logo-container {
            position: relative;
            display: inline-block;
        }
        
        .logo-upload {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .logo-image {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        
        .logo-image:hover {
            border-color: #5D5CDE;
        }
        
        .dark .logo-image {
            border-color: #4b5563;
        }
        
        .dark .logo-image:hover {
            border-color: #5D5CDE;
        }
        
        /* Index error styles */
        .error-container {
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            margin-bottom: 1rem;
        }
        
        .dark .error-container {
            background-color: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
        }
        
        .index-instructions {
            margin-top: 0.5rem;
        }
        
        .index-link {
            color: #5D5CDE;
            text-decoration: underline;
        }
        
        .dark .index-link {
            color: #8b8bf4;
        }

        /* Language toggle button styles */
        .lang-toggle {
            transition: all 0.3s ease;
        }
        
        .lang-toggle:hover {
            transform: scale(1.05);
        }

        /* RTL specific styles */
        [dir="rtl"] .space-x-4 > :not([hidden]) ~ :not([hidden]) {
            margin-right: 1rem;
            margin-left: 0;
        }

        [dir="rtl"] .space-x-3 > :not([hidden]) ~ :not([hidden]) {
            margin-right: 0.75rem;
            margin-left: 0;
        }

        [dir="rtl"] .mr-2 {
            margin-right: 0;
            margin-left: 0.5rem;
        }

        [dir="rtl"] .mr-3 {
            margin-right: 0;
            margin-left: 0.75rem;
        }

        [dir="rtl"] .mr-4 {
            margin-right: 0;
            margin-left: 1rem;
        }

        [dir="rtl"] .ml-2 {
            margin-left: 0;
            margin-right: 0.5rem;
        }

        [dir="rtl"] .ml-5 {
            margin-left: 0;
            margin-right: 1.25rem;
        }

        [dir="rtl"] .pl-2 {
            padding-left: 0;
            padding-right: 0.5rem;
        }

        /* Text alignment for RTL */
        [dir="rtl"] .text-left {
            text-align: right;
        }

        [dir="rtl"] .text-right {
            text-align: left;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Top navigation bar -->
        <nav class="bg-white dark:bg-gray-800 rounded-lg shadow-md mb-6 p-4">
            <div class="flex items-center justify-between flex-wrap">
                <div class="flex items-center space-x-4 rtl:space-x-reverse">
                    <!-- Custom Logo Upload -->
                    <div class="logo-container">
                        <img id="school-logo" src="" alt="School Logo" class="logo-image" style="display: none;">
                        <div id="default-logo" class="h-12 w-12 flex-shrink-0">
                            <img src="https://www2.0zz0.com/2025/07/19/13/298532964.jpg" 
                                 alt="Baniyas International School Logo" 
                                 class="w-full h-full rounded-full object-cover border-2 border-primary">
                        </div>
                        <input type="file" id="logo-upload" class="logo-upload" accept="image/*" title="Click to change logo">
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-primary dark:text-blue-400" data-i18n="nursery_title">Baniyas International School</h1>
                        <span class="hidden md:inline text-sm px-3 py-1 bg-primary-dark text-white rounded-full" data-i18n="system_subtitle">Risk Assessment System</span>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3 rtl:space-x-reverse mt-4 md:mt-0">
                    <!-- Language Toggle Button -->
                    <button id="lang-toggle" class="lang-toggle px-3 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg text-sm font-medium transition-all duration-200 flex items-center">
                        <span id="lang-flag">🇺🇸</span>
                        <span id="lang-text" class="mr-1 ml-1">EN</span>
                    </button>
                    <span id="user-status" class="text-sm hidden">Guest</span>
                    <button id="login-button" class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg text-sm font-medium transition-colors duration-200" data-i18n="login">Login</button>
                    <button id="logout-button" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg text-sm font-medium transition-colors duration-200 hidden" data-i18n="logout">Logout</button>
                </div>
            </div>
        </nav>
        
        <!-- Auth section for login/register -->
        <div id="auth-container" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-medium" id="auth-title" data-i18n="login">Login</h2>
                <button id="close-auth" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium mb-1" data-i18n="email">Email</label>
                    <input type="email" id="email" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" required>
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium mb-1" data-i18n="password">Password</label>
                    <input type="password" id="password" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" required>
                </div>
                
                <div id="auth-error" class="text-red-500 text-sm hidden"></div>
                
                <div class="flex space-x-4 rtl:space-x-reverse">
                    <button type="submit" id="auth-submit" class="flex-1 py-2 px-4 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg transition duration-200" data-i18n="login">
                        Login
                    </button>
                    <button type="button" id="auth-switch" class="py-2 px-4 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-medium rounded-lg transition duration-200" data-i18n="register">
                        Register
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Main app container - only shown when logged in -->
        <div id="app-container" class="hidden">
            <!-- Dashboard header with date -->
            <header class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between">
                <div>
                    <h2 class="text-2xl font-bold" data-i18n="daily_risk_assessment">Daily Risk Assessment</h2>
                    <p class="text-gray-600 dark:text-gray-400" id="current-date-display">Loading...</p>
                </div>
                <div class="mt-4 md:mt-0 flex space-x-3 rtl:space-x-reverse">
                    <div class="relative">
                        <label for="assessment-date" class="block text-sm font-medium mb-1" data-i18n="assessment_date">Assessment Date:</label>
                        <input type="date" id="assessment-date" class="p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" required>
                    </div>
                    <div class="flex items-end space-x-2 rtl:space-x-reverse">
                        <button id="manage-locations-btn" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm transition" data-i18n="manage_locations">
                            Manage Locations
                        </button>
                        <button id="manage-risks-btn" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm transition" data-i18n="manage_risks">
                            Manage Risk Types
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- Advanced Search Panel -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium" data-i18n="advanced_search">Advanced Search</h3>
                    <button id="toggle-search" class="text-primary dark:text-blue-400 hover:underline flex items-center space-x-1 rtl:space-x-reverse">
                        <span id="toggle-text" data-i18n="show_search">Show Search</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                </div>
                
                <div id="search-panel" class="hidden">
                    <form id="search-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label for="search-date-from" class="block text-sm font-medium" data-i18n="date_from">Date From:</label>
                                <input type="date" id="search-date-from" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                            
                            <div class="space-y-2">
                                <label for="search-date-to" class="block text-sm font-medium" data-i18n="date_to">Date To:</label>
                                <input type="date" id="search-date-to" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label for="search-location" class="block text-sm font-medium" data-i18n="location">Location:</label>
                                <select id="search-location" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                    <option value="" data-i18n="all_locations">All Locations</option>
                                </select>
                            </div>
                            
                            <div class="space-y-2">
                                <label for="search-risk-level" class="block text-sm font-medium" data-i18n="risk_level">Risk Level:</label>
                                <select id="search-risk-level" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                    <option value="" data-i18n="all_risk_levels">All Risk Levels</option>
                                    <option value="high" data-i18n="high">High</option>
                                    <option value="medium" data-i18n="medium">Medium</option>
                                    <option value="low" data-i18n="low">Low</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label for="search-affected" class="block text-sm font-medium" data-i18n="affected_people">Affected People:</label>
                                <select id="search-affected" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                    <option value="" data-i18n="all_groups">All Groups</option>
                                    <option value="children" data-i18n="children">Children</option>
                                    <option value="teachers" data-i18n="teachers">Teachers</option>
                                    <option value="staff" data-i18n="staff">Staff</option>
                                    <option value="others" data-i18n="others">Others</option>
                                    <option value="everyone" data-i18n="everyone">Everyone</option>
                                </select>
                            </div>
                            
                            <div class="space-y-2">
                                <label for="search-keyword" class="block text-sm font-medium" data-i18n="keyword">Keyword:</label>
                                <input type="text" id="search-keyword" data-i18n-placeholder="search_placeholder" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 rtl:space-x-reverse">
                            <button type="submit" class="flex-1 py-2 px-4 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg transition duration-200" data-i18n="search">
                                Search
                            </button>
                            <button type="button" id="clear-search" class="py-2 px-4 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-medium rounded-lg transition duration-200" data-i18n="clear">
                                Clear
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Two-column layout for desktop -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Assessment Form -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-medium mb-4" data-i18n="new_risk_assessment">New Risk Assessment</h3>
                    <form id="risk-assessment-form" class="space-y-5">
                        <div class="space-y-2">
                            <label for="location" class="block font-medium" data-i18n="location">Location:</label>
                            <select id="location" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" required>
                                <option value="" disabled selected data-i18n="select_location">Select a location</option>
                            </select>
                        </div>
                        
                        <div class="space-y-2">
                            <label for="risk-type" class="block font-medium" data-i18n="risk_type">Risk Type:</label>
                            <select id="risk-type" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" required>
                                <option value="" disabled selected data-i18n="select_risk_type">Select a risk type</option>
                            </select>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block font-medium" data-i18n="risk_level">Risk Level:</label>
                            <div class="flex flex-wrap gap-4">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="radio" name="risk-level" value="high" class="sr-only peer" required>
                                    <div class="w-6 h-6 border-2 border-red-500 rounded-full peer-checked:bg-red-500 peer-checked:border-red-500 mr-2 rtl:mr-0 rtl:ml-2"></div>
                                    <span class="text-red-500 font-medium" data-i18n="high">High</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="radio" name="risk-level" value="medium" class="sr-only peer">
                                    <div class="w-6 h-6 border-2 border-orange-500 rounded-full peer-checked:bg-orange-500 peer-checked:border-orange-500 mr-2 rtl:mr-0 rtl:ml-2"></div>
                                    <span class="text-orange-500 font-medium" data-i18n="medium">Medium</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="radio" name="risk-level" value="low" class="sr-only peer">
                                    <div class="w-6 h-6 border-2 border-green-500 rounded-full peer-checked:bg-green-500 peer-checked:border-green-500 mr-2 rtl:mr-0 rtl:ml-2"></div>
                                    <span class="text-green-500 font-medium" data-i18n="low">Low</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block font-medium" data-i18n="affected_people">Affected People:</label>
                            <div class="flex flex-wrap gap-3">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="affected" value="children" class="sr-only peer">
                                    <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full peer-checked:bg-blue-600 peer-checked:text-white text-sm font-medium transition-colors dark:bg-blue-900 dark:text-blue-200 dark:peer-checked:bg-blue-600 dark:peer-checked:text-white" data-i18n="children">
                                        Children
                                    </div>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="affected" value="teachers" class="sr-only peer">
                                    <div class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full peer-checked:bg-purple-600 peer-checked:text-white text-sm font-medium transition-colors dark:bg-purple-900 dark:text-purple-200 dark:peer-checked:bg-purple-600 dark:peer-checked:text-white" data-i18n="teachers">
                                        Teachers
                                    </div>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="affected" value="staff" class="sr-only peer">
                                    <div class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full peer-checked:bg-orange-600 peer-checked:text-white text-sm font-medium transition-colors dark:bg-orange-900 dark:text-orange-200 dark:peer-checked:bg-orange-600 dark:peer-checked:text-white" data-i18n="staff">
                                        Staff
                                    </div>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="affected" value="others" class="sr-only peer">
                                    <div class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full peer-checked:bg-gray-600 peer-checked:text-white text-sm font-medium transition-colors dark:bg-gray-700 dark:text-gray-300 dark:peer-checked:bg-gray-600 dark:peer-checked:text-white" data-i18n="others">
                                        Others
                                    </div>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="affected" value="everyone" class="sr-only peer">
                                    <div class="bg-red-100 text-red-800 px-3 py-1 rounded-full peer-checked:bg-red-600 peer-checked:text-white text-sm font-medium transition-colors dark:bg-red-900 dark:text-red-200 dark:peer-checked:bg-red-600 dark:peer-checked:text-white" data-i18n="everyone">
                                        Everyone
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <label for="mitigation" class="block font-medium" data-i18n="mitigation_strategy">Risk Mitigation Strategy:</label>
                            <textarea id="mitigation" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" rows="3" data-i18n-placeholder="mitigation_placeholder" required></textarea>
                        </div>
                        
                        <div class="space-y-2">
                            <label for="notes" class="block font-medium" data-i18n="additional_notes">Additional Notes:</label>
                            <textarea id="notes" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" rows="2" data-i18n-placeholder="notes_placeholder"></textarea>
                        </div>
                        
                        <div id="submit-error" class="text-red-500 text-sm hidden"></div>
                        
                        <button type="submit" class="w-full py-3 px-6 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg transition duration-200 flex items-center justify-center">
                            <span id="submit-btn-text" data-i18n="add_risk_assessment">Add Risk Assessment</span>
                            <span id="submit-spinner" class="spinner ml-2 rtl:ml-0 rtl:mr-2 hidden"></span>
                        </button>
                    </form>
                </div>
                
                <!-- Guidelines Section and Results -->
                <div class="space-y-6">
                    <!-- Guidelines Section -->
                    <div id="guidelines-container" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 hidden">
                        <h3 class="text-lg font-bold mb-4" data-i18n="risk_guidelines">Risk Management Guidelines</h3>
                        <div id="guidelines-content" class="space-y-4"></div>
                    </div>
                    
                    <!-- Firestore Index Error Message -->
                    <div id="index-error-container" class="error-container hidden">
                        <h4 class="font-bold text-red-600 dark:text-red-400" data-i18n="index_required">Index Creation Required</h4>
                        <p data-i18n="index_description">This query requires creating an index in Firebase. Follow these steps:</p>
                        <ol class="index-instructions mt-2 ml-5 rtl:ml-0 rtl:mr-5 list-decimal">
                            <li data-i18n="index_step1">Click the link below to open Firebase console</li>
                            <li data-i18n="index_step2">Sign in to your Firebase account</li>
                            <li data-i18n="index_step3">Click "Create Index" button in Firestore page</li>
                            <li data-i18n="index_step4">Wait a few minutes for the index to be created</li>
                            <li data-i18n="index_step5">Return to the app and try again</li>
                        </ol>
                        <div class="mt-4">
                            <a id="index-link" href="#" target="_blank" class="index-link font-medium" data-i18n="open_index_link">Open Index Creation Link</a>
                        </div>
                    </div>
                    
                    <!-- Assessment Results -->
                    <div id="assessment-results" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium" data-i18n="risk_assessments">Risk Assessments</h3>
                            <div class="flex space-x-2 rtl:space-x-reverse">
                                <button id="export-excel" class="py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition duration-200 flex items-center" disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 rtl:mr-0 rtl:ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    <span data-i18n="export_excel">Export to Excel</span>
                                </button>
                                <button id="export-pdf" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition duration-200 flex items-center" disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 rtl:mr-0 rtl:ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                    </svg>
                                    <span data-i18n="export_pdf">Export to PDF</span>
                                </button>
                                <button id="print-pdf" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition duration-200 flex items-center" disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 rtl:mr-0 rtl:ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                    </svg>
                                    <span data-i18n="print_pdf">Print PDF</span>
                                </button>
                            </div>
                        </div>
                        <div id="loading-assessments" class="py-10 text-center">
                            <div class="spinner mb-3"></div>
                            <p data-i18n="loading_assessments">Loading assessments...</p>
                        </div>
                        <div id="no-assessments" class="text-center py-8 text-gray-500 dark:text-gray-400 hidden" data-i18n="no_assessments">
                            No risk assessments added yet.
                        </div>
                        <div id="assessment-table-container" class="responsive-table hidden">
                            <table class="assessment-table">
                                <thead>
                                    <tr>
                                        <th data-i18n="location">Location</th>
                                        <th data-i18n="risk_type">Risk Type</th>
                                        <th data-i18n="risk_level">Risk Level</th>
                                        <th data-i18n="affected">Affected</th>
                                        <th data-i18n="mitigation">Mitigation</th>
                                        <th data-i18n="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="assessment-list">
                                    <!-- Table rows will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Assessment Details Modal -->
    <div id="details-modal" class="modal">
        <div class="modal-content modal-content-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium" id="details-modal-title" data-i18n="assessment_details">Risk Assessment Details</h3>
                <button id="close-details-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <div id="details-content" class="space-y-4">
                <!-- Details will be populated here -->
            </div>
            <div class="mt-6 flex justify-end">
                <button id="close-details-btn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-medium rounded-lg transition-colors duration-200" data-i18n="close">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Assessment Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content modal-content-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium" data-i18n="edit_assessment">Edit Risk Assessment</h3>
                <button id="close-edit-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <form id="edit-assessment-form" class="space-y-4">
                <!-- Edit form will be populated here -->
            </form>
        </div>
    </div>

    <!-- Manage Locations Modal -->
    <div id="locations-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium" data-i18n="manage_locations">Manage Locations</h3>
                <button id="close-locations-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <form id="add-location-form" class="space-y-3">
                    <h4 class="font-medium" data-i18n="add_new_location">Add New Location</h4>
                    <div>
                        <label for="location-en" class="block text-sm font-medium mb-1">English Name:</label>
                        <input type="text" id="location-en" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" required>
                    </div>
                    <div>
                        <label for="location-ar" class="block text-sm font-medium mb-1">Arabic Name:</label>
                        <input type="text" id="location-ar" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" required>
                    </div>
                    <button type="submit" class="w-full py-2 px-4 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg transition" data-i18n="add_location">
                        Add Location
                    </button>
                </form>
                
                <div id="locations-list" class="space-y-2 max-h-60 overflow-y-auto">
                    <h4 class="font-medium" data-i18n="existing_locations">Existing Locations</h4>
                    <!-- Locations will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Risk Types Modal -->
    <div id="risks-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium" data-i18n="manage_risks">Manage Risk Types</h3>
                <button id="close-risks-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <form id="add-risk-form" class="space-y-3">
                    <h4 class="font-medium" data-i18n="add_new_risk_type">Add New Risk Type</h4>
                    <div>
                        <label for="risk-location-select" class="block text-sm font-medium mb-1" data-i18n="location">Location:</label>
                        <select id="risk-location-select" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" required>
                            <option value="" disabled selected data-i18n="select_location">Select a location</option>
                        </select>
                    </div>
                    <div>
                        <label for="risk-en" class="block text-sm font-medium mb-1">English Risk Type:</label>
                        <input type="text" id="risk-en" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" required>
                    </div>
                    <div>
                        <label for="risk-ar" class="block text-sm font-medium mb-1">Arabic Risk Type:</label>
                        <input type="text" id="risk-ar" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" required>
                    </div>
                    <button type="submit" class="w-full py-2 px-4 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg transition" data-i18n="add_risk_type">
                        Add Risk Type
                    </button>
                </form>
                
                <div id="risks-list" class="space-y-2 max-h-60 overflow-y-auto">
                    <h4 class="font-medium" data-i18n="existing_risk_types">Existing Risk Types</h4>
                    <!-- Risk types will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium" id="modal-title" data-i18n="confirm_action">Confirm Action</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <p id="modal-message" class="mb-6" data-i18n="confirm_message">Are you sure you want to perform this action?</p>
            <div class="flex justify-end space-x-4 rtl:space-x-reverse">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-medium rounded-lg transition-colors duration-200" data-i18n="cancel">
                    Cancel
                </button>
                <button id="modal-confirm" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors duration-200" data-i18n="confirm">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div id="toast" class="fixed bottom-4 right-4 rtl:right-auto rtl:left-4 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md transition-all duration-300 transform translate-y-24 opacity-0 z-50 max-w-xs">
        <div class="flex items-center">
            <div class="mr-3 rtl:mr-0 rtl:ml-3 text-green-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <div class="flex-1 mr-2 rtl:mr-0 rtl:ml-2">
                <p id="toast-message" class="text-sm font-medium"></p>
            </div>
            <button id="close-toast" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyC_VmcPTAucmBoQLpkU9XnIkbTKpyMCveY",
          authDomain: "riskmanagment-1e216.firebaseapp.com",
          databaseURL: "https://riskmanagment-1e216-default-rtdb.firebaseio.com",
          projectId: "riskmanagment-1e216",
          storageBucket: "riskmanagment-1e216.firebasestorage.app",
          messagingSenderId: "798397100025",
          appId: "1:798397100025:web:0f2470e79bc6231b681728",
          measurementId: "G-MZFLL7G3LT"
        };
        
        // Initialize Firebase with a specific project
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Language system
        let currentLanguage = 'en';
        
        const translations = {
            en: {
                // Navigation and Header
                nursery_title: "Baniyas International School",
                system_subtitle: "Risk Assessment System",
                login: "Login",
                logout: "Logout",
                
                // Authentication
                email: "Email",
                password: "Password",
                register: "Register",
                
                // Main App
                daily_risk_assessment: "Daily Risk Assessment",
                assessment_date: "Assessment Date:",
                advanced_search: "Advanced Search",
                show_search: "Show Search",
                hide_search: "Hide Search",
                
                // Search Form
                date_from: "Date From:",
                date_to: "Date To:",
                location: "Location:",
                all_locations: "All Locations",
                risk_level: "Risk Level:",
                all_risk_levels: "All Risk Levels",
                affected_people: "Affected People:",
                all_groups: "All Groups",
                keyword: "Keyword:",
                search_placeholder: "Search in risk type, mitigation or notes...",
                search: "Search",
                clear: "Clear",
                
                // Risk Assessment Form
                new_risk_assessment: "New Risk Assessment",
                select_location: "Select a location",
                risk_type: "Risk Type:",
                select_risk_type: "Select a risk type",
                high: "High",
                medium: "Medium",
                low: "Low",
                children: "Children",
                teachers: "Teachers",
                staff: "Staff",
                others: "Others",
                everyone: "Everyone",
                mitigation_strategy: "Risk Mitigation Strategy:",
                mitigation_placeholder: "Describe steps to mitigate this risk...",
                additional_notes: "Additional Notes:",
                notes_placeholder: "Add any additional information about the risk...",
                add_risk_assessment: "Add Risk Assessment",
                edit_assessment: "Edit Risk Assessment",
                update_assessment: "Update Assessment",
                
                // Management
                manage_locations: "Manage Locations",
                manage_risks: "Manage Risk Types",
                add_new_location: "Add New Location",
                add_location: "Add Location",
                existing_locations: "Existing Locations",
                add_new_risk_type: "Add New Risk Type",
                add_risk_type: "Add Risk Type",
                existing_risk_types: "Existing Risk Types",
                
                // Guidelines
                risk_guidelines: "Risk Management Guidelines",
                
                // Index Error
                index_required: "Index Creation Required",
                index_description: "This query requires creating an index in Firebase. Follow these steps:",
                index_step1: "Click the link below to open Firebase console",
                index_step2: "Sign in to your Firebase account",
                index_step3: "Click \"Create Index\" button in Firestore page",
                index_step4: "Wait a few minutes for the index to be created",
                index_step5: "Return to the app and try again",
                open_index_link: "Open Index Creation Link",
                
                // Assessment Results
                risk_assessments: "Risk Assessments",
                export_excel: "Export to Excel",
                export_pdf: "Export to PDF",
                print_pdf: "Print PDF",
                loading_assessments: "Loading assessments...",
                no_assessments: "No risk assessments added yet.",
                affected: "Affected",
                mitigation: "Mitigation",
                actions: "Actions",
                view: "View",
                edit: "Edit",
                delete: "Delete",
                
                // Modal
                assessment_details: "Risk Assessment Details",
                close: "Close",
                confirm_action: "Confirm Action",
                confirm_message: "Are you sure you want to perform this action?",
                cancel: "Cancel",
                confirm: "Confirm",
                
                // Locations
                "room-0-1": "Room 0-1 years",
                "room-1-2": "Room 1-2 years",
                "room-2-3": "Room 2-3 years",
                "indoor-play": "Indoor play areas",
                "sand-play": "Sand play",
                "messy-play": "Messy play / cooking",
                "drop-pickup": "Drop off / pick up",
                "outings": "Outings",
                "health-illness": "Health & illness",
                
                // Toast messages
                added_successfully: "Risk assessment added successfully",
                updated_successfully: "Risk assessment updated successfully",
                deleted_successfully: "Risk assessment deleted successfully",
                logged_in_successfully: "Logged in successfully",
                account_created_successfully: "Account created successfully",
                no_assessments_export: "No assessments to export",
                excel_downloaded: "Excel file downloaded successfully",
                pdf_downloaded: "PDF file downloaded successfully",
                location_added: "Location added successfully",
                risk_type_added: "Risk type added successfully",
                
                // Error messages
                fill_required_fields: "Please fill in all required fields",
                
                // Date format
                date_format: "en-US"
            },
            ar: {
                // Navigation and Header
                nursery_title: "مدرسة بني ياس الدولية الخاصة",
                system_subtitle: "نظام تقييم المخاطر",
                login: "تسجيل الدخول",
                logout: "تسجيل الخروج",
                
                // Authentication
                email: "البريد الإلكتروني",
                password: "كلمة المرور",
                register: "إنشاء حساب",
                
                // Main App
                daily_risk_assessment: "تقييم المخاطر اليومي",
                assessment_date: "تاريخ التقييم:",
                advanced_search: "البحث المتقدم",
                show_search: "إظهار البحث",
                hide_search: "إخفاء البحث",
                
                // Search Form
                date_from: "التاريخ من:",
                date_to: "التاريخ إلى:",
                location: "المكان:",
                all_locations: "جميع الأماكن",
                risk_level: "مستوى المخاطر:",
                all_risk_levels: "جميع مستويات المخاطر",
                affected_people: "الأشخاص المتأثرون:",
                all_groups: "جميع المجموعات",
                keyword: "الكلمة المفتاحية:",
                search_placeholder: "البحث في نوع المخاطر أو التخفيف أو الملاحظات...",
                search: "بحث",
                clear: "مسح",
                
                // Risk Assessment Form
                new_risk_assessment: "تقييم مخاطر جديد",
                select_location: "اختر مكانًا",
                risk_type: "نوع المخاطر:",
                select_risk_type: "اختر نوع المخاطر",
                high: "عالي",
                medium: "متوسط",
                low: "منخفض",
                children: "الأطفال",
                teachers: "المعلمون",
                staff: "الموظفون",
                others: "آخرون",
                everyone: "الجميع",
                mitigation_strategy: "استراتيجية تخفيف المخاطر:",
                mitigation_placeholder: "اوصف الخطوات للحد من هذه المخاطر...",
                additional_notes: "ملاحظات إضافية:",
                notes_placeholder: "أضف أي معلومات إضافية حول المخاطر...",
                add_risk_assessment: "إضافة تقييم المخاطر",
                edit_assessment: "تعديل تقييم المخاطر",
                update_assessment: "تحديث التقييم",
                
                // Management
                manage_locations: "إدارة الأماكن",
                manage_risks: "إدارة أنواع المخاطر",
                add_new_location: "إضافة مكان جديد",
                add_location: "إضافة مكان",
                existing_locations: "الأماكن الموجودة",
                add_new_risk_type: "إضافة نوع مخاطر جديد",
                add_risk_type: "إضافة نوع مخاطر",
                existing_risk_types: "أنواع المخاطر الموجودة",
                
                // Guidelines
                risk_guidelines: "إرشادات إدارة المخاطر",
                
                // Index Error
                index_required: "إنشاء فهرس مطلوب",
                index_description: "يتطلب هذا الاستعلام إنشاء فهرس في Firebase. اتبع الخطوات التالية:",
                index_step1: "انقر على الرابط أدناه لفتح لوحة تحكم Firebase",
                index_step2: "قم بتسجيل الدخول إلى حساب Firebase الخاص بك",
                index_step3: "انقر على زر \"Create Index\" في صفحة Firestore",
                index_step4: "انتظر بضع دقائق حتى يتم إنشاء الفهرس",
                index_step5: "عد إلى التطبيق وحاول مرة أخرى",
                open_index_link: "افتح رابط إنشاء الفهرس",
                
                // Assessment Results
                risk_assessments: "تقييمات المخاطر",
                export_excel: "تصدير إلى Excel",
                export_pdf: "تصدير إلى PDF",
                print_pdf: "طباعة PDF",
                loading_assessments: "جاري تحميل التقييمات...",
                no_assessments: "لم يتم إضافة أي تقييمات مخاطر بعد.",
                affected: "المتأثرون",
                mitigation: "التخفيف",
                actions: "الإجراءات",
                view: "عرض",
                edit: "تعديل",
                delete: "حذف",
                
                // Modal
                assessment_details: "تفاصيل تقييم المخاطر",
                close: "إغلاق",
                confirm_action: "تأكيد الإجراء",
                confirm_message: "هل أنت متأكد من أنك تريد تنفيذ هذا الإجراء؟",
                cancel: "إلغاء",
                confirm: "تأكيد",
                
                // Locations
                "room-0-1": "غرفة 0-1 سنة",
                "room-1-2": "غرفة 1-2 سنة",
                "room-2-3": "غرفة 2-3 سنوات",
                "indoor-play": "مناطق اللعب الداخلية",
                "sand-play": "لعب الرمل",
                "messy-play": "اللعب الفوضوي / الطبخ",
                "drop-pickup": "التوصيل / الاستلام",
                "outings": "الرحلات",
                "health-illness": "الصحة والمرض",
                
                // Toast messages
                added_successfully: "تم إضافة تقييم المخاطر بنجاح",
                updated_successfully: "تم تحديث تقييم المخاطر بنجاح",
                deleted_successfully: "تم حذف تقييم المخاطر بنجاح",
                logged_in_successfully: "تم تسجيل الدخول بنجاح",
                account_created_successfully: "تم إنشاء الحساب بنجاح",
                no_assessments_export: "لا توجد تقييمات للتصدير",
                excel_downloaded: "تم تنزيل ملف Excel بنجاح",
                pdf_downloaded: "تم تنزيل ملف PDF بنجاح",
                location_added: "تم إضافة المكان بنجاح",
                risk_type_added: "تم إضافة نوع المخاطر بنجاح",
                
                // Error messages
                fill_required_fields: "يرجى ملء جميع الحقول المطلوبة",
                
                // Date format
                date_format: "ar-EG"
            }
        };
        
        // Custom locations and risk types storage
        let customLocations = {};
        let customRiskTypes = {};
        
        // Initialize dark mode based on user preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // Logo management
        function initLogo() {
            const logoUpload = document.getElementById('logo-upload');
            const schoolLogo = document.getElementById('school-logo');
            const defaultLogo = document.getElementById('default-logo');
            
            // Load saved logo from localStorage
            const savedLogo = localStorage.getItem('schoolLogo');
            if (savedLogo) {
                schoolLogo.src = savedLogo;
                schoolLogo.style.display = 'block';
                defaultLogo.style.display = 'none';
            }
            
            logoUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const logoDataUrl = e.target.result;
                        schoolLogo.src = logoDataUrl;
                        schoolLogo.style.display = 'block';
                        defaultLogo.style.display = 'none';
                        
                        // Save to localStorage
                        localStorage.setItem('schoolLogo', logoDataUrl);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // Language management functions
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'en' ? 'ar' : 'en';
            updateLanguage();
        }
        
        function updateLanguage() {
            const html = document.documentElement;
            const langFlag = document.getElementById('lang-flag');
            const langText = document.getElementById('lang-text');
            
            if (currentLanguage === 'ar') {
                html.setAttribute('lang', 'ar');
                html.setAttribute('dir', 'rtl');
                langFlag.textContent = '🇸🇦';
                langText.textContent = 'العربية';
            } else {
                html.setAttribute('lang', 'en');
                html.setAttribute('dir', 'ltr');
                langFlag.textContent = '🇺🇸';
                langText.textContent = 'EN';
            }
            
            // Update all translatable elements
            updateTranslations();
            
            // Update location and search dropdowns
            updateLocationDropdowns();
            
            // Update placeholders
            updatePlaceholders();
        }
        
        function updateTranslations() {
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });
        }
        
        function updatePlaceholders() {
            const elements = document.querySelectorAll('[data-i18n-placeholder]');
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (translations[currentLanguage][key]) {
                    element.setAttribute('placeholder', translations[currentLanguage][key]);
                }
            });
        }
        
        function updateLocationDropdowns() {
            const locationSelect = document.getElementById('location');
            const searchLocationSelect = document.getElementById('search-location');
            const riskLocationSelect = document.getElementById('risk-location-select');
            
            // Clear existing options (except the first placeholder option)
            locationSelect.innerHTML = `<option value="" disabled selected>${translations[currentLanguage].select_location}</option>`;
            searchLocationSelect.innerHTML = `<option value="">${translations[currentLanguage].all_locations}</option>`;
            if (riskLocationSelect) {
                riskLocationSelect.innerHTML = `<option value="" disabled selected>${translations[currentLanguage].select_location}</option>`;
            }
            
            // Get all locations (default + custom)
            const allLocations = { ...getDefaultLocations(), ...customLocations };
            
            Object.keys(allLocations).forEach(key => {
                const locationName = allLocations[key][currentLanguage] || allLocations[key]['en'];
                
                const option1 = document.createElement('option');
                option1.value = key;
                option1.textContent = locationName;
                locationSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = locationName;
                option2.textContent = locationName;
                searchLocationSelect.appendChild(option2);
                
                if (riskLocationSelect) {
                    const option3 = document.createElement('option');
                    option3.value = key;
                    option3.textContent = locationName;
                    riskLocationSelect.appendChild(option3);
                }
            });
        }
        
        function getDefaultLocations() {
            return {
                'room-0-1': { en: 'Room 0-1 years', ar: 'غرفة 0-1 سنة' },
                'room-1-2': { en: 'Room 1-2 years', ar: 'غرفة 1-2 سنة' },
                'room-2-3': { en: 'Room 2-3 years', ar: 'غرفة 2-3 سنوات' },
                'indoor-play': { en: 'Indoor play areas', ar: 'مناطق اللعب الداخلية' },
                'sand-play': { en: 'Sand play', ar: 'لعب الرمل' },
                'messy-play': { en: 'Messy play / cooking', ar: 'اللعب الفوضوي / الطبخ' },
                'drop-pickup': { en: 'Drop off / pick up', ar: 'التوصيل / الاستلام' },
                'outings': { en: 'Outings', ar: 'الرحلات' },
                'health-illness': { en: 'Health & illness', ar: 'الصحة والمرض' }
            };
        }
        
        function t(key) {
            return translations[currentLanguage][key] || key;
        }
        
        // Set default date to today
        function initDatePicker() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;
            
            const datePicker = document.getElementById('assessment-date');
            datePicker.value = formattedDate;
            datePicker.setAttribute('max', formattedDate); // Don't allow future dates
            
            // Update date display
            updateCurrentDateDisplay(today);
        }
        
        function updateCurrentDateDisplay(date) {
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const locale = translations[currentLanguage].date_format;
            document.getElementById('current-date-display').textContent = date.toLocaleDateString(locale, options);
        }
        
        // Format date for display
        function formatDate(date) {
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const locale = translations[currentLanguage].date_format;
            return date.toLocaleDateString(locale, options);
        }
        
        // Format time
        function formatTime(date) {
            const timeOptions = { hour: '2-digit', minute: '2-digit' };
            const locale = translations[currentLanguage].date_format;
            return date.toLocaleTimeString(locale, timeOptions);
        }
        
        // Check for Firestore index error message and extract the URL
        function extractIndexUrl(errorMessage) {
            const regex = /You can create it here: (https:\/\/[^\s]+)/;
            const match = errorMessage.match(regex);
            return match ? match[1] : null;
        }
        
        // Risk types by location for nursery (English)
        const risksByLocationEn = {
            "room-0-1": [
                "Choking hazards (small objects/toys)",
                "Crib/sleeping area safety",
                "Unstable furniture tipping",
                "Strangulation hazards (cords/strings)",
                "Improper formula/milk preparation",
                "Allergic reactions (food/materials)",
                "Spread of illness between infants",
                "Falling from changing tables",
                "Improper handling injuries",
                "Floor hazards for crawling babies"
            ],
            "room-1-2": [
                "Climbing hazards (furniture)",
                "Sharp corners on tables/furniture",
                "Access to unsafe storage areas",
                "Strangulation hazards (cords/toys)",
                "Choking hazards (small toys/food)",
                "Improper supervision during play",
                "Floor hazards (slips/trips)",
                "Pinching hazards (doors/equipment)",
                "Spread of illness between toddlers",
                "Window access risks"
            ],
            "room-2-3": [
                "Unsafe use of classroom equipment",
                "Running indoors collisions",
                "Playground equipment misuse indoors",
                "Scissors and art supplies hazards",
                "Climbing on chairs/tables/shelves",
                "Access to unsafe storage areas",
                "Aggressive behavior between children",
                "Electrical outlets/cords",
                "Toys with small parts (choking)",
                "Door pinching/slamming injuries"
            ],
            "indoor-play": [
                "Equipment in disrepair",
                "Improper use of play equipment",
                "Overcrowding in play areas",
                "Fall hazards (climbing equipment)",
                "Collisions between children",
                "Slipping hazards (wet floors)",
                "Unsecured equipment tipping",
                "Inappropriate toys for age groups",
                "Aggressive behavior during play",
                "Inadequate supervision"
            ],
            "sand-play": [
                "Foreign objects in sand",
                "Sand in eyes/mouth/ears",
                "Contamination of sand",
                "Throwing sand at others",
                "Animal access to sand (overnight)",
                "Inadequate sun protection",
                "Drainage issues after rain",
                "Sand pit edging (trips/falls)",
                "Limited visibility for supervision",
                "Allergic reactions to sand"
            ],
            "messy-play": [
                "Allergic reactions to materials",
                "Ingestion of play materials",
                "Hot surfaces (cooking activities)",
                "Sharp utensils/tools",
                "Slip hazards from spills",
                "Chemical reactions (vinegar/baking soda)",
                "Burns from cooking activities",
                "Improper hand washing after activities",
                "Cross-contamination of food",
                "Choking on food during cooking activities"
            ],
            "drop-pickup": [
                "Vehicle traffic in pickup areas",
                "Unauthorized person pickup attempts",
                "Children released to wrong adults",
                "Unsupervised children during transition",
                "Weather hazards (rain/heat/wind)",
                "Multiple children departing simultaneously",
                "Late pickup scenarios",
                "Children running in parking areas",
                "Security breach during busy periods",
                "Vehicle accidents in loading zones"
            ],
            "outings": [
                "Transportation safety (buses/vehicles)",
                "Lost child during outing",
                "Traffic hazards during walks",
                "Weather exposure (heat/rain/cold)",
                "Medical emergencies away from nursery",
                "Water hazards on field trips",
                "Uneven terrain (trips/falls)",
                "Food safety during outdoor meals",
                "Exposure to allergens/plants",
                "Inadequate supervision ratios"
            ],
            "health-illness": [
                "Infectious disease outbreak",
                "Medication administration errors",
                "Allergic reactions (severe)",
                "Choking incidents",
                "Seizures or medical emergencies",
                "Improper first aid procedures",
                "Inadequate hand washing/hygiene",
                "Unidentified illness symptoms",
                "Head injuries/concussions",
                "Sanitization of contaminated areas"
            ]
        };
        
        // Risk types by location for nursery (Arabic)
        const risksByLocationAr = {
            "room-0-1": [
                "مخاطر الاختناق (أشياء/ألعاب صغيرة)",
                "أمان منطقة النوم/السرير",
                "انقلاب الأثاث غير المستقر",
                "مخاطر الخنق (أسلاك/خيوط)",
                "تحضير غير صحيح للحليب الصناعي",
                "ردود فعل تحسسية (طعام/مواد)",
                "انتشار الأمراض بين الرضع",
                "السقوط من طاولات التغيير",
                "إصابات التعامل غير الصحيح",
                "مخاطر الأرضية للأطفال الذين يزحفون"
            ],
            "room-1-2": [
                "مخاطر التسلق (الأثاث)",
                "زوايا حادة على الطاولات/الأثاث",
                "الوصول إلى مناطق تخزين غير آمنة",
                "مخاطر الخنق (أسلاك/ألعاب)",
                "مخاطر الاختناق (ألعاب صغيرة/طعام)",
                "إشراف غير صحيح أثناء اللعب",
                "مخاطر الأرضية (انزلاق/تعثر)",
                "مخاطر الضغط (أبواب/معدات)",
                "انتشار الأمراض بين الأطفال الصغار",
                "مخاطر الوصول للنوافذ"
            ],
            "room-2-3": [
                "الاستخدام غير الآمن لمعدات الفصل",
                "تصادمات الجري في الداخل",
                "سوء استخدام معدات الملعب في الداخل",
                "مخاطر المقص ولوازم الفن",
                "التسلق على الكراسي/الطاولات/الرفوف",
                "الوصول إلى مناطق تخزين غير آمنة",
                "سلوك عدواني بين الأطفال",
                "مقابس/أسلاك كهربائية",
                "ألعاب بقطع صغيرة (اختناق)",
                "إصابات ضغط/إغلاق الأبواب"
            ],
            "indoor-play": [
                "معدات في حالة سيئة",
                "الاستخدام غير الصحيح لمعدات اللعب",
                "الازدحام في مناطق اللعب",
                "مخاطر السقوط (معدات التسلق)",
                "تصادمات بين الأطفال",
                "مخاطر الانزلاق (أرضيات مبللة)",
                "انقلاب معدات غير مثبتة",
                "ألعاب غير مناسبة للفئة العمرية",
                "سلوك عدواني أثناء اللعب",
                "إشراف غير كافٍ"
            ],
            "sand-play": [
                "أجسام غريبة في الرمل",
                "رمل في العيون/الفم/الأذنين",
                "تلوث الرمل",
                "رمي الرمل على الآخرين",
                "وصول الحيوانات للرمل (بين عشية وضحاها)",
                "حماية غير كافية من الشمس",
                "مشاكل الصرف بعد المطر",
                "حواف حفرة الرمل (تعثر/سقوط)",
                "رؤية محدودة للإشراف",
                "ردود فعل تحسسية للرمل"
            ],
            "messy-play": [
                "ردود فعل تحسسية للمواد",
                "ابتلاع مواد اللعب",
                "أسطح ساخنة (أنشطة الطبخ)",
                "أدوات/أدوات حادة",
                "مخاطر الانزلاق من الانسكابات",
                "تفاعلات كيميائية (خل/بيكربونات الصوديوم)",
                "حروق من أنشطة الطبخ",
                "غسل اليدين غير الصحيح بعد الأنشطة",
                "تلوث متبادل للطعام",
                "الاختناق بالطعام أثناء أنشطة الطبخ"
            ],
            "drop-pickup": [
                "حركة مرور المركبات في مناطق الاستلام",
                "محاولات استلام من أشخاص غير مخولين",
                "تسليم الأطفال لبالغين خطأ",
                "أطفال غير مراقبين أثناء الانتقال",
                "مخاطر الطقس (مطر/حر/رياح)",
                "مغادرة عدة أطفال في نفس الوقت",
                "سيناريوهات الاستلام المتأخر",
                "جري الأطفال في مناطق الانتظار",
                "خرق أمني خلال فترات الذروة",
                "حوادث المركبات في مناطق التحميل"
            ],
            "outings": [
                "سلامة النقل (حافلات/مركبات)",
                "فقدان طفل أثناء الرحلة",
                "مخاطر المرور أثناء المشي",
                "التعرض للطقس (حر/مطر/برد)",
                "حالات طوارئ طبية بعيداً عن الحضانة",
                "مخاطر المياه في الرحلات الميدانية",
                "تضاريس غير مستوية (تعثر/سقوط)",
                "سلامة الطعام أثناء وجبات الهواء الطلق",
                "التعرض لمسببات الحساسية/النباتات",
                "نسب إشراف غير كافية"
            ],
            "health-illness": [
                "تفشي مرض معدي",
                "أخطاء إعطاء الدواء",
                "ردود فعل تحسسية (شديدة)",
                "حوادث اختناق",
                "نوبات أو حالات طوارئ طبية",
                "إجراءات إسعافات أولية غير صحيحة",
                "غسل اليدين/النظافة غير الكافي",
                "أعراض مرض غير محددة",
                "إصابات الرأس/ارتجاج",
                "تطهير المناطق الملوثة"
            ]
        };
        
        // Get risks by location based on current language
        function getRisksByLocation() {
            return currentLanguage === 'ar' ? risksByLocationAr : risksByLocationEn;
        }
        
        // Suggested mitigations by risk type
        const suggestedMitigationsEn = {
            "Choking hazards (small objects/toys)": "Daily inspection for small objects, regular staff training on choking prevention, proper toy selection for age group, and regular maintenance checks.",
            "Crib/sleeping area safety": "Regular inspection of crib hardware, proper mattress fitting, clear sleep area from blankets/toys, staff training on safe sleep practices.",
            "Falling from changing tables": "Install safety rails, maintain constant supervision, prepare supplies beforehand, consider floor-level changing areas when possible.",
            "Aggressive behavior between children": "Implement clear behavior expectations, increase supervision during high-risk times, teach conflict resolution skills, communicate with parents about behavior concerns.",
            "Vehicle traffic in pickup areas": "Establish clear one-way traffic flow, assign staff to supervise pickup areas, create physical barriers between vehicle areas and walkways, implement staggered pickup times.",
            "Infectious disease outbreak": "Enforce strict handwashing protocols, regular disinfection of high-touch surfaces, isolation of symptomatic children, communication system for notifying parents of outbreaks."
        };
        
        const suggestedMitigationsAr = {
            "مخاطر الاختناق (أشياء/ألعاب صغيرة)": "فحص يومي للأشياء الصغيرة، تدريب منتظم للموظفين على منع الاختناق، اختيار ألعاب مناسبة للفئة العمرية، وفحوصات صيانة منتظمة.",
            "أمان منطقة النوم/السرير": "فحص منتظم لأجهزة السرير، ملاءمة صحيحة للمرتبة، إزالة البطانيات/الألعاب من منطقة النوم، تدريب الموظفين على ممارسات النوم الآمن.",
            "السقوط من طاولات التغيير": "تركيب درابزين الأمان، المحافظة على إشراف مستمر، تحضير المستلزمات مسبقاً، النظر في مناطق تغيير على مستوى الأرض عند الإمكان.",
            "سلوك عدواني بين الأطفال": "تطبيق توقعات سلوكية واضحة، زيادة الإشراف خلال الأوقات عالية المخاطر، تعليم مهارات حل النزاعات، التواصل مع الأهل حول اهتمامات السلوك.",
            "حركة مرور المركبات في مناطق الاستلام": "وضع تدفق مروري واضح باتجاه واحد، تعيين موظفين لمراقبة مناطق الاستلام، إنشاء حواجز مادية بين مناطق المركبات والممرات، تطبيق أوقات استلام متدرجة.",
            "تفشي مرض معدي": "فرض بروتوكولات صارمة لغسل اليدين، تطهير منتظم للأسطح عالية التلامس، عزل الأطفال ذوي الأعراض، نظام تواصل لإخطار الأهل بالتفشي."
        };
        
        // Get suggested mitigations based on current language
        function getSuggestedMitigations() {
            return currentLanguage === 'ar' ? suggestedMitigationsAr : suggestedMitigationsEn;
        }
        
        // Risk management guidelines specific to nursery environment
        const riskGuidelinesEn = {
            high: [
                "IMMEDIATE ACTION: Stop all activities in the affected area",
                "Alert nursery director/manager immediately",
                "Move children to safe alternative location",
                "Document incident with photos if possible",
                "Contact maintenance/emergency services if needed",
                "Reassess area before allowing children to return",
                "Complete detailed incident report form",
                "Inform all staff during daily briefing",
                "Review and update risk assessment procedures",
                "Contact parents if children were affected or at risk"
            ],
            medium: [
                "Address within 24 hours - cordon off area if needed",
                "Inform supervisor or room leader immediately",
                "Document details in maintenance/risk log",
                "Post temporary warning signs if applicable",
                "Assign staff member to monitor the situation",
                "Schedule maintenance repair within 24-48 hours",
                "Create temporary alternative arrangements",
                "Brief relevant staff on safety precautions",
                "Follow up to ensure complete resolution",
                "Update nursery safety procedures if needed"
            ],
            low: [
                "Monitor situation throughout the day",
                "Add to routine maintenance schedule",
                "Document in daily inspection log",
                "Brief staff during next scheduled meeting",
                "Consider preventative measures to avoid escalation",
                "Schedule for routine maintenance check",
                "Reassess at end of week to ensure status unchanged",
                "Include in monthly safety review",
                "Use as teaching opportunity for children if applicable",
                "Update safety checklists if needed"
            ]
        };
        
        const riskGuidelinesAr = {
            high: [
                "إجراء فوري: إيقاف جميع الأنشطة في المنطقة المتأثرة",
                "تنبيه مدير/مديرة الحضانة فوراً",
                "نقل الأطفال إلى مكان آمن بديل",
                "توثيق الحادث بالصور إن أمكن",
                "الاتصال بخدمات الصيانة/الطوارئ عند الحاجة",
                "إعادة تقييم المنطقة قبل السماح للأطفال بالعودة",
                "إكمال تقرير حادث مفصل",
                "إعلام جميع الموظفين خلال الإحاطة اليومية",
                "مراجعة وتحديث إجراءات تقييم المخاطر",
                "الاتصال بالأهل إذا تأثر الأطفال أو كانوا معرضين للخطر"
            ],
            medium: [
                "المعالجة خلال 24 ساعة - عزل المنطقة عند الحاجة",
                "إعلام المشرف أو قائد الغرفة فوراً",
                "توثيق التفاصيل في سجل الصيانة/المخاطر",
                "وضع علامات تحذيرية مؤقتة عند الحاجة",
                "تعيين موظف لمراقبة الوضع",
                "جدولة إصلاح الصيانة خلال 24-48 ساعة",
                "إنشاء ترتيبات بديلة مؤقتة",
                "إحاطة الموظفين المعنيين بشأن احتياطات السلامة",
                "المتابعة لضمان الحل الكامل",
                "تحديث إجراءات سلامة الحضانة عند الحاجة"
            ],
            low: [
                "مراقبة الوضع طوال اليوم",
                "الإضافة إلى جدول الصيانة الروتيني",
                "التوثيق في سجل التفتيش اليومي",
                "إحاطة الموظفين خلال الاجتماع المجدول التالي",
                "النظر في التدابير الوقائية لتجنب التصعيد",
                "جدولة لفحص الصيانة الروتيني",
                "إعادة التقييم في نهاية الأسبوع للتأكد من عدم تغير الوضع",
                "الإدراج في المراجعة الشهرية للسلامة",
                "استخدام كفرصة تعليمية للأطفال عند الحاجة",
                "تحديث قوائم فحص السلامة عند الحاجة"
            ]
        };
        
        // Get risk guidelines based on current language
        function getRiskGuidelines() {
            return currentLanguage === 'ar' ? riskGuidelinesAr : riskGuidelinesEn;
        }
        
        // Affected people labels
        const affectedLabelsEn = {
            children: "Children",
            teachers: "Teachers",
            staff: "Staff",
            others: "Others",
            everyone: "Everyone"
        };
        
        const affectedLabelsAr = {
            children: "الأطفال",
            teachers: "المعلمون",
            staff: "الموظفون",
            others: "آخرون",
            everyone: "الجميع"
        };
        
        // Get affected labels based on current language
        function getAffectedLabels() {
            return currentLanguage === 'ar' ? affectedLabelsAr : affectedLabelsEn;
        }
        
        // Load custom data from localStorage
        function loadCustomData() {
            const savedLocations = localStorage.getItem('customLocations');
            if (savedLocations) {
                customLocations = JSON.parse(savedLocations);
            }
            
            const savedRiskTypes = localStorage.getItem('customRiskTypes');
            if (savedRiskTypes) {
                customRiskTypes = JSON.parse(savedRiskTypes);
            }
        }
        
        // Save custom data to localStorage
        function saveCustomData() {
            localStorage.setItem('customLocations', JSON.stringify(customLocations));
            localStorage.setItem('customRiskTypes', JSON.stringify(customRiskTypes));
        }
        
        // Show assessment details in modal
        function showAssessmentDetails(assessment) {
            const detailsModal = document.getElementById('details-modal');
            const detailsContent = document.getElementById('details-content');
            const closeDetailsBtn = document.getElementById('close-details-btn');
            const closeDetailsModal = document.getElementById('close-details-modal');
            
            // Format time if timestamp exists
            let formattedTime = t('loading_assessments').replace('...', '');
            if (assessment.timestamp) {
                const date = assessment.timestamp.toDate();
                formattedTime = formatTime(date);
            }
            
            // Create affected people chips
            const affectedLabels = getAffectedLabels();
            const affectedChips = assessment.affected.map(person => 
                `<span class="chip chip-${person}">${affectedLabels[person]}</span>`
            ).join('');
            
            // Build HTML content
            detailsContent.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h4 class="text-lg font-bold">${assessment.location}</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">${currentLanguage === 'ar' ? 'أُضيف في' : 'Added at'} ${formattedTime}</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="font-medium">${t('risk_type')}:</p>
                            <p>${assessment.riskType}</p>
                        </div>
                        
                        <div>
                            <p class="font-medium">${t('risk_level')}:</p>
                            <span class="risk-badge risk-badge-${assessment.riskLevel}">
                                ${t(assessment.riskLevel)}
                            </span>
                        </div>
                    </div>
                    
                    <div>
                        <p class="font-medium">${t('affected_people')}:</p>
                        <div class="mt-1">${affectedChips}</div>
                    </div>
                    
                    <div class="pt-2 border-t border-gray-200 dark:border-gray-700">
                        <p class="font-medium">${t('mitigation_strategy')}:</p>
                        <p class="mt-1">${assessment.mitigation}</p>
                    </div>
                    
                    ${assessment.notes ? `
                    <div class="pt-2 border-t border-gray-200 dark:border-gray-700">
                        <p class="font-medium">${t('additional_notes')}:</p>
                        <p class="mt-1">${assessment.notes}</p>
                    </div>` : ''}
                    
                    <div class="pt-2 border-t border-gray-200 dark:border-gray-700">
                        <p class="font-medium">${currentLanguage === 'ar' ? 'أُنشئ بواسطة:' : 'Created By:'}:</p>
                        <p class="mt-1">${assessment.createdByEmail || (currentLanguage === 'ar' ? 'مجهول' : 'Anonymous')}</p>
                    </div>
                </div>
            `;
            
            // Show modal
            detailsModal.style.display = 'flex';
            
            // Close modal function
            const closeModal = function() {
                detailsModal.style.display = 'none';
                closeDetailsBtn.removeEventListener('click', closeModal);
                closeDetailsModal.removeEventListener('click', closeModal);
            };
            
            // Add event listeners
            closeDetailsBtn.addEventListener('click', closeModal);
            closeDetailsModal.addEventListener('click', closeModal);
        }
        
        // Show edit assessment modal
        function showEditAssessment(id, assessment) {
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-assessment-form');
            const closeEditModal = document.getElementById('close-edit-modal');
            
            // Create form HTML
            editForm.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label for="edit-location" class="block font-medium mb-2" data-i18n="location">Location:</label>
                        <select id="edit-location" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" required>
                            ${getLocationOptions(assessment.locationKey)}
                        </select>
                    </div>
                    
                    <div>
                        <label for="edit-risk-type" class="block font-medium mb-2" data-i18n="risk_type">Risk Type:</label>
                        <select id="edit-risk-type" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" required>
                            <option value="" disabled>${t('select_risk_type')}</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block font-medium mb-2" data-i18n="risk_level">Risk Level:</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="edit-risk-level" value="high" class="sr-only peer" ${assessment.riskLevel === 'high' ? 'checked' : ''} required>
                                <div class="w-6 h-6 border-2 border-red-500 rounded-full peer-checked:bg-red-500 peer-checked:border-red-500 mr-2 rtl:mr-0 rtl:ml-2"></div>
                                <span class="text-red-500 font-medium" data-i18n="high">High</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="edit-risk-level" value="medium" class="sr-only peer" ${assessment.riskLevel === 'medium' ? 'checked' : ''}>
                                <div class="w-6 h-6 border-2 border-orange-500 rounded-full peer-checked:bg-orange-500 peer-checked:border-orange-500 mr-2 rtl:mr-0 rtl:ml-2"></div>
                                <span class="text-orange-500 font-medium" data-i18n="medium">Medium</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="edit-risk-level" value="low" class="sr-only peer" ${assessment.riskLevel === 'low' ? 'checked' : ''}>
                                <div class="w-6 h-6 border-2 border-green-500 rounded-full peer-checked:bg-green-500 peer-checked:border-green-500 mr-2 rtl:mr-0 rtl:ml-2"></div>
                                <span class="text-green-500 font-medium" data-i18n="low">Low</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block font-medium mb-2" data-i18n="affected_people">Affected People:</label>
                        <div class="flex flex-wrap gap-3">
                            ${getAffectedOptions(assessment.affected)}
                        </div>
                    </div>
                    
                    <div>
                        <label for="edit-mitigation" class="block font-medium mb-2" data-i18n="mitigation_strategy">Risk Mitigation Strategy:</label>
                        <textarea id="edit-mitigation" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" rows="3" required>${assessment.mitigation}</textarea>
                    </div>
                    
                    <div>
                        <label for="edit-notes" class="block font-medium mb-2" data-i18n="additional_notes">Additional Notes:</label>
                        <textarea id="edit-notes" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" rows="2">${assessment.notes || ''}</textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 rtl:space-x-reverse pt-4">
                        <button type="button" id="cancel-edit" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-medium rounded-lg transition-colors duration-200" data-i18n="cancel">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg transition-colors duration-200" data-i18n="update_assessment">
                            Update Assessment
                        </button>
                    </div>
                </div>
            `;
            
            // Update translations
            updateTranslations();
            
            // Populate risk types based on selected location
            const editLocationSelect = document.getElementById('edit-location');
            const editRiskTypeSelect = document.getElementById('edit-risk-type');
            
            updateRiskTypesForLocation(editLocationSelect.value, editRiskTypeSelect, assessment.riskTypeKey);
            
            editLocationSelect.addEventListener('change', function() {
                updateRiskTypesForLocation(this.value, editRiskTypeSelect);
            });
            
            // Show modal
            editModal.style.display = 'flex';
            
            // Handle form submission
            editForm.addEventListener('submit', function(e) {
                e.preventDefault();
                updateAssessment(id);
            });
            
            // Handle cancel
            document.getElementById('cancel-edit').addEventListener('click', function() {
                editModal.style.display = 'none';
            });
            
            // Handle close
            closeEditModal.addEventListener('click', function() {
                editModal.style.display = 'none';
            });
        }
        
        function getLocationOptions(selectedKey) {
            const allLocations = { ...getDefaultLocations(), ...customLocations };
            let options = `<option value="" disabled>${t('select_location')}</option>`;
            
            Object.keys(allLocations).forEach(key => {
                const locationName = allLocations[key][currentLanguage] || allLocations[key]['en'];
                const selected = key === selectedKey ? 'selected' : '';
                options += `<option value="${key}" ${selected}>${locationName}</option>`;
            });
            
            return options;
        }
        
        function getAffectedOptions(selectedAffected) {
            const affectedOptions = ['children', 'teachers', 'staff', 'others', 'everyone'];
            const labels = getAffectedLabels();
            
            return affectedOptions.map(option => {
                const checked = selectedAffected.includes(option) ? 'checked' : '';
                return `
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="edit-affected" value="${option}" class="sr-only peer" ${checked}>
                        <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full peer-checked:bg-blue-600 peer-checked:text-white text-sm font-medium transition-colors dark:bg-blue-900 dark:text-blue-200 dark:peer-checked:bg-blue-600 dark:peer-checked:text-white">
                            ${labels[option]}
                        </div>
                    </label>
                `;
            }).join('');
        }
        
        function updateRiskTypesForLocation(locationKey, riskTypeSelect, selectedRiskKey = null) {
            // Clear existing options
            riskTypeSelect.innerHTML = `<option value="" disabled selected>${t('select_risk_type')}</option>`;
            
            if (!locationKey) return;
            
            // Get risks for this location
            const defaultRisks = getRisksByLocation()[locationKey] || [];
            const customRisks = customRiskTypes[locationKey] || {};
            
            // Add default risks
            defaultRisks.forEach(risk => {
                const riskKey = risk.toLowerCase().replace(/\s+/g, '-');
                const selected = riskKey === selectedRiskKey ? 'selected' : '';
                const option = document.createElement('option');
                option.value = riskKey;
                option.textContent = risk;
                option.selected = selected;
                riskTypeSelect.appendChild(option);
            });
            
            // Add custom risks
            Object.keys(customRisks).forEach(riskKey => {
                const riskName = customRisks[riskKey][currentLanguage] || customRisks[riskKey]['en'];
                const selected = riskKey === selectedRiskKey ? 'selected' : '';
                const option = document.createElement('option');
                option.value = riskKey;
                option.textContent = riskName;
                option.selected = selected;
                riskTypeSelect.appendChild(option);
            });
        }
        
        function updateAssessment(id) {
            const editLocation = document.getElementById('edit-location');
            const editRiskType = document.getElementById('edit-risk-type');
            const editRiskLevel = document.querySelector('input[name="edit-risk-level"]:checked');
            const editAffected = Array.from(document.querySelectorAll('input[name="edit-affected"]:checked')).map(checkbox => checkbox.value);
            const editMitigation = document.getElementById('edit-mitigation').value.trim();
            const editNotes = document.getElementById('edit-notes').value.trim();
            
            // Validate required fields
            if (!editLocation.value || !editRiskType.value || !editRiskLevel || !editMitigation || editAffected.length === 0) {
                showToast('fill_required_fields');
                return;
            }
            
            const updatedData = {
                location: editLocation.options[editLocation.selectedIndex].text,
                locationKey: editLocation.value,
                riskType: editRiskType.options[editRiskType.selectedIndex].text,
                riskTypeKey: editRiskType.value,
                riskLevel: editRiskLevel.value,
                affected: editAffected,
                mitigation: editMitigation,
                notes: editNotes,
                language: currentLanguage,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection('assessments').doc(id).update(updatedData)
                .then(() => {
                    document.getElementById('edit-modal').style.display = 'none';
                    showToast('updated_successfully');
                    loadAssessments();
                })
                .catch(error => {
                    console.error("Error updating assessment: ", error);
                    showToast(`Error: ${error.message}`);
                });
        }
        
        // Toast notification function
        function showToast(messageKey, duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = t(messageKey);
            toast.classList.remove('translate-y-24', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-y-24', 'opacity-0');
            }, duration);
        }
        
        // Close toast when clicking the close button
        document.getElementById('close-toast').addEventListener('click', function() {
            document.getElementById('toast').classList.add('translate-y-24', 'opacity-0');
        });
        
        // Custom confirm dialog
        function showConfirmDialog(messageKey, confirmCallback) {
            const modal = document.getElementById('confirm-modal');
            const modalMessage = document.getElementById('modal-message');
            const confirmButton = document.getElementById('modal-confirm');
            const cancelButton = document.getElementById('modal-cancel');
            const closeButton = document.getElementById('close-modal');
            
            modalMessage.textContent = t(messageKey);
            modal.style.display = 'flex';
            
            // Setup event listeners
            const confirmHandler = function() {
                modal.style.display = 'none';
                confirmButton.removeEventListener('click', confirmHandler);
                cancelButton.removeEventListener('click', cancelHandler);
                closeButton.removeEventListener('click', cancelHandler);
                confirmCallback(true);
            };
            
            const cancelHandler = function() {
                modal.style.display = 'none';
                confirmButton.removeEventListener('click', confirmHandler);
                cancelButton.removeEventListener('click', cancelHandler);
                closeButton.removeEventListener('click', cancelHandler);
                confirmCallback(false);
            };
            
            confirmButton.addEventListener('click', confirmHandler);
            cancelButton.addEventListener('click', cancelHandler);
            closeButton.addEventListener('click', cancelHandler);
        }
        
        // PDF Export function
        function exportToPDF() {
            const selectedDate = document.getElementById('assessment-date').value;
            
            // Query Firestore for assessments on selected date
            db.collection('assessments')
                .where('assessmentDate', '==', selectedDate)
                .get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        showToast('no_assessments_export');
                        return;
                    }
                    
                    generatePDF(querySnapshot, selectedDate);
                })
                .catch(error => {
                    console.error("Error exporting to PDF: ", error);
                    showToast(`Error: ${error.message}`);
                });
        }
        
        function generatePDF(querySnapshot, selectedDate) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            const dateParts = selectedDate.split('-');
            const assessmentDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
            const formattedDate = formatDate(assessmentDate);
            
            // Set font (use default fonts for Arabic support)
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            
            const title = currentLanguage === 'ar' ? 
                'مدرسة بني ياس الدولية الخاصة - تقييم المخاطر اليومي' : 
                'Baniyas International School - Daily Risk Assessment';
            
            // Add logo if available
            const logoImg = document.getElementById('school-logo');
            if (logoImg.style.display !== 'none' && logoImg.src) {
                try {
                    doc.addImage(logoImg.src, 'JPEG', 15, 15, 25, 25);
                    doc.text(title, 45, 25);
                } catch (e) {
                    doc.text(title, 15, 25);
                }
            } else {
                doc.text(title, 15, 25);
            }
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            
            const dateLabel = currentLanguage === 'ar' ? 'التاريخ:' : 'Date:';
            doc.text(`${dateLabel} ${formattedDate}`, 15, 40);
            
            // Sort documents by timestamp
            const sortedDocs = querySnapshot.docs.slice();
            sortedDocs.sort((a, b) => {
                const timestampA = a.data().timestamp;
                const timestampB = b.data().timestamp;
                
                if (!timestampA) return -1;
                if (!timestampB) return 1;
                
                return timestampB.seconds - timestampA.seconds || 
                       timestampB.nanoseconds - timestampA.nanoseconds;
            });
            
            let yPosition = 55;
            const affectedLabels = getAffectedLabels();
            
            sortedDocs.forEach((docSnapshot, index) => {
                const data = docSnapshot.data();
                
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Risk assessment entry
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text(`${index + 1}. ${data.location}`, 15, yPosition);
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                yPosition += 8;
                
                doc.text(`${t('risk_type')}: ${data.riskType}`, 20, yPosition);
                yPosition += 6;
                
                doc.text(`${t('risk_level')}: ${t(data.riskLevel)}`, 20, yPosition);
                yPosition += 6;
                
                const affectedText = data.affected.map(a => affectedLabels[a]).join(', ');
                doc.text(`${t('affected_people')}: ${affectedText}`, 20, yPosition);
                yPosition += 6;
                
                // Wrap mitigation text
                const mitigationLines = doc.splitTextToSize(`${t('mitigation_strategy')}: ${data.mitigation}`, 170);
                doc.text(mitigationLines, 20, yPosition);
                yPosition += mitigationLines.length * 5;
                
                if (data.notes) {
                    const notesLines = doc.splitTextToSize(`${t('additional_notes')}: ${data.notes}`, 170);
                    doc.text(notesLines, 20, yPosition);
                    yPosition += notesLines.length * 5;
                }
                
                let formattedTime = currentLanguage === 'ar' ? 'الآن' : 'Just now';
                if (data.timestamp) {
                    const date = data.timestamp.toDate();
                    formattedTime = formatTime(date);
                }
                
                doc.setFontSize(8);
                doc.text(`${currentLanguage === 'ar' ? 'الوقت:' : 'Time:'} ${formattedTime} | ${currentLanguage === 'ar' ? 'بواسطة:' : 'By:'} ${data.createdByEmail || (currentLanguage === 'ar' ? 'مجهول' : 'Anonymous')}`, 20, yPosition);
                
                yPosition += 12;
            });
            
            // Save the PDF
            const fileName = `Risk_Assessment_${selectedDate}.pdf`;
            doc.save(fileName);
            showToast('pdf_downloaded');
        }
        
        // Print PDF function
        function printPDF() {
            const selectedDate = document.getElementById('assessment-date').value;
            
            // Query Firestore for assessments on selected date
            db.collection('assessments')
                .where('assessmentDate', '==', selectedDate)
                .get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        showToast('no_assessments_export');
                        return;
                    }
                    
                    generateAndPrintPDF(querySnapshot, selectedDate);
                })
                .catch(error => {
                    console.error("Error printing PDF: ", error);
                    showToast(`Error: ${error.message}`);
                });
        }
        
        function generateAndPrintPDF(querySnapshot, selectedDate) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            const dateParts = selectedDate.split('-');
            const assessmentDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
            const formattedDate = formatDate(assessmentDate);
            
            // Set font (use default fonts for Arabic support)
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            
            const title = currentLanguage === 'ar' ? 
                'مدرسة بني ياس الدولية الخاصة - تقييم المخاطر اليومي' : 
                'Baniyas International School - Daily Risk Assessment';
            
            // Add logo if available
            const logoImg = document.getElementById('school-logo');
            if (logoImg.style.display !== 'none' && logoImg.src) {
                try {
                    doc.addImage(logoImg.src, 'JPEG', 15, 15, 25, 25);
                    doc.text(title, 45, 25);
                } catch (e) {
                    doc.text(title, 15, 25);
                }
            } else {
                doc.text(title, 15, 25);
            }
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            
            const dateLabel = currentLanguage === 'ar' ? 'التاريخ:' : 'Date:';
            doc.text(`${dateLabel} ${formattedDate}`, 15, 40);
            
            // Sort documents by timestamp
            const sortedDocs = querySnapshot.docs.slice();
            sortedDocs.sort((a, b) => {
                const timestampA = a.data().timestamp;
                const timestampB = b.data().timestamp;
                
                if (!timestampA) return -1;
                if (!timestampB) return 1;
                
                return timestampB.seconds - timestampA.seconds || 
                       timestampB.nanoseconds - timestampA.nanoseconds;
            });
            
            let yPosition = 55;
            const affectedLabels = getAffectedLabels();
            
            sortedDocs.forEach((docSnapshot, index) => {
                const data = docSnapshot.data();
                
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Risk assessment entry
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text(`${index + 1}. ${data.location}`, 15, yPosition);
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                yPosition += 8;
                
                doc.text(`${t('risk_type')}: ${data.riskType}`, 20, yPosition);
                yPosition += 6;
                
                doc.text(`${t('risk_level')}: ${t(data.riskLevel)}`, 20, yPosition);
                yPosition += 6;
                
                const affectedText = data.affected.map(a => affectedLabels[a]).join(', ');
                doc.text(`${t('affected_people')}: ${affectedText}`, 20, yPosition);
                yPosition += 6;
                
                // Wrap mitigation text
                const mitigationLines = doc.splitTextToSize(`${t('mitigation_strategy')}: ${data.mitigation}`, 170);
                doc.text(mitigationLines, 20, yPosition);
                yPosition += mitigationLines.length * 5;
                
                if (data.notes) {
                    const notesLines = doc.splitTextToSize(`${t('additional_notes')}: ${data.notes}`, 170);
                    doc.text(notesLines, 20, yPosition);
                    yPosition += notesLines.length * 5;
                }
                
                let formattedTime = currentLanguage === 'ar' ? 'الآن' : 'Just now';
                if (data.timestamp) {
                    const date = data.timestamp.toDate();
                    formattedTime = formatTime(date);
                }
                
                doc.setFontSize(8);
                doc.text(`${currentLanguage === 'ar' ? 'الوقت:' : 'Time:'} ${formattedTime} | ${currentLanguage === 'ar' ? 'بواسطة:' : 'By:'} ${data.createdByEmail || (currentLanguage === 'ar' ? 'مجهول' : 'Anonymous')}`, 20, yPosition);
                
                yPosition += 12;
            });
            
            // Print the PDF
            doc.autoPrint();
            const pdfBlob = doc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            const printWindow = window.open(pdfUrl);
            printWindow.onload = function() {
                printWindow.print();
            };
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize language first
            updateLanguage();
            
            // Load custom data
            loadCustomData();
            
            // Initialize logo
            initLogo();
            
            initDatePicker();
            setupAuth();
            setupManagementModals();
            
            // Language toggle button
            document.getElementById('lang-toggle').addEventListener('click', toggleLanguage);
            
            // Update risk types when location changes
            document.getElementById('location').addEventListener('change', function() {
                const location = this.value;
                const riskTypeSelect = document.getElementById('risk-type');
                
                updateRiskTypesForLocation(location, riskTypeSelect);
            });
            
            // Auto-fill mitigation when risk type is selected
            document.getElementById('risk-type').addEventListener('change', function() {
                const riskTypeSelect = document.getElementById('risk-type');
                const mitigationTextarea = document.getElementById('mitigation');
                const selectedRiskText = riskTypeSelect.options[riskTypeSelect.selectedIndex].textContent;
                
                // If we have a suggested mitigation for this risk type, prefill it
                const suggestedMitigations = getSuggestedMitigations();
                if (suggestedMitigations[selectedRiskText]) {
                    mitigationTextarea.value = suggestedMitigations[selectedRiskText];
                } else {
                    mitigationTextarea.value = '';
                }
            });
            
            // Show guidelines when risk level is selected
            document.querySelectorAll('input[name="risk-level"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const level = this.value;
                    const guidelinesContainer = document.getElementById('guidelines-container');
                    const guidelinesContent = document.getElementById('guidelines-content');
                    
                    // Clear existing guidelines
                    guidelinesContent.innerHTML = '';
                    
                    // Show guidelines based on selected risk level
                    const riskGuidelines = getRiskGuidelines();
                    if (level && riskGuidelines[level]) {
                        const ul = document.createElement('ul');
                        ul.className = `risk-${level} p-4 rounded-lg fade-in`;
                        
                        riskGuidelines[level].forEach(guideline => {
                            const li = document.createElement('li');
                            li.className = 'py-1 pl-2 rtl:pl-0 rtl:pr-2';
                            li.textContent = guideline;
                            ul.appendChild(li);
                        });
                        
                        guidelinesContent.appendChild(ul);
                        guidelinesContainer.classList.remove('hidden');
                    }
                });
            });
            
            // Handle form submission
            document.getElementById('risk-assessment-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Show spinner
                document.getElementById('submit-btn-text').classList.add('hidden');
                document.getElementById('submit-spinner').classList.remove('hidden');
                document.getElementById('submit-error').classList.add('hidden');
                
                // Get form values
                const location = document.getElementById('location');
                const riskType = document.getElementById('risk-type');
                const riskLevel = document.querySelector('input[name="risk-level"]:checked');
                const affected = Array.from(document.querySelectorAll('input[name="affected"]:checked')).map(checkbox => checkbox.value);
                const mitigation = document.getElementById('mitigation').value.trim();
                const notes = document.getElementById('notes').value.trim();
                const selectedDate = document.getElementById('assessment-date').value;
                
                // Validate required fields
                if (!location.value || !riskType.value || !riskLevel || !mitigation || affected.length === 0 || !selectedDate) {
                    document.getElementById('submit-error').textContent = t('fill_required_fields');
                    document.getElementById('submit-error').classList.remove('hidden');
                    document.getElementById('submit-btn-text').classList.remove('hidden');
                    document.getElementById('submit-spinner').classList.add('hidden');
                    return;
                }
                
                // Create assessment data object
                const assessment = {
                    location: location.options[location.selectedIndex].text,
                    locationKey: location.value,
                    riskType: riskType.options[riskType.selectedIndex].text,
                    riskTypeKey: riskType.value,
                    riskLevel: riskLevel.value,
                    affected: affected,
                    mitigation: mitigation,
                    notes: notes,
                    assessmentDate: selectedDate,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: auth.currentUser ? auth.currentUser.uid : 'anonymous',
                    createdByEmail: auth.currentUser ? auth.currentUser.email : 'guest',
                    language: currentLanguage
                };
                
                // Add to Firestore
                db.collection('assessments').add(assessment)
                    .then(() => {
                        // Reset form (but keep the date)
                        const currentDate = selectedDate;
                        document.getElementById('risk-assessment-form').reset();
                        document.getElementById('assessment-date').value = currentDate;
                        document.getElementById('guidelines-container').classList.add('hidden');
                        
                        // Show success toast
                        showToast('added_successfully');
                        
                        // Refresh assessments
                        loadAssessments();
                        
                        // Hide spinner
                        document.getElementById('submit-btn-text').classList.remove('hidden');
                        document.getElementById('submit-spinner').classList.add('hidden');
                    })
                    .catch(error => {
                        console.error("Error adding assessment: ", error);
                        document.getElementById('submit-error').textContent = `Error: ${error.message}`;
                        document.getElementById('submit-error').classList.remove('hidden');
                        document.getElementById('submit-btn-text').classList.remove('hidden');
                        document.getElementById('submit-spinner').classList.add('hidden');
                    });
            });
            
            // Toggle search panel
            document.getElementById('toggle-search').addEventListener('click', function() {
                const searchPanel = document.getElementById('search-panel');
                const toggleText = document.getElementById('toggle-text');
                const toggleIcon = this.querySelector('svg');
                
                searchPanel.classList.toggle('hidden');
                
                if (searchPanel.classList.contains('hidden')) {
                    toggleText.textContent = t('show_search');
                    toggleIcon.classList.remove('rotate-180');
                } else {
                    toggleText.textContent = t('hide_search');
                    toggleIcon.classList.add('rotate-180');
                }
            });
            
            // Clear search
            document.getElementById('clear-search').addEventListener('click', function() {
                document.getElementById('search-form').reset();
                loadAssessments(); // Load all assessments again
            });
            
            // Handle search form submission
            document.getElementById('search-form').addEventListener('submit', function(e) {
                e.preventDefault();
                searchAssessments();
            });
            
            // Date picker change
            document.getElementById('assessment-date').addEventListener('change', function() {
                const date = new Date(this.value);
                updateCurrentDateDisplay(date);
                loadAssessments();
            });
            
            // Export buttons
            document.getElementById('export-excel').addEventListener('click', exportToExcel);
            document.getElementById('export-pdf').addEventListener('click', exportToPDF);
            document.getElementById('print-pdf').addEventListener('click', printPDF);
            
            // Management buttons
            document.getElementById('manage-locations-btn').addEventListener('click', function() {
                document.getElementById('locations-modal').style.display = 'flex';
                loadLocationsList();
            });
            
            document.getElementById('manage-risks-btn').addEventListener('click', function() {
                document.getElementById('risks-modal').style.display = 'flex';
                loadRisksList();
                updateLocationDropdowns(); // Refresh risk location dropdown
            });
            
            // Check auth state
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    document.getElementById('app-container').classList.remove('hidden');
                    document.getElementById('auth-container').classList.add('hidden');
                    document.getElementById('login-button').classList.add('hidden');
                    document.getElementById('logout-button').classList.remove('hidden');
                    document.getElementById('user-status').textContent = user.email;
                    document.getElementById('user-status').classList.remove('hidden');
                    
                    // Load assessments
                    loadAssessments();
                } else {
                    // User is signed out
                    document.getElementById('app-container').classList.add('hidden');
                    document.getElementById('auth-container').classList.add('hidden');
                    document.getElementById('login-button').classList.remove('hidden');
                    document.getElementById('logout-button').classList.add('hidden');
                    document.getElementById('user-status').classList.add('hidden');
                }
            });
        });
        
        // Setup management modals
        function setupManagementModals() {
            // Close modals
            document.getElementById('close-locations-modal').addEventListener('click', function() {
                document.getElementById('locations-modal').style.display = 'none';
            });
            
            document.getElementById('close-risks-modal').addEventListener('click', function() {
                document.getElementById('risks-modal').style.display = 'none';
            });
            
            // Add location form
            document.getElementById('add-location-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const enName = document.getElementById('location-en').value.trim();
                const arName = document.getElementById('location-ar').value.trim();
                
                if (!enName || !arName) {
                    showToast('fill_required_fields');
                    return;
                }
                
                const locationKey = enName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                
                customLocations[locationKey] = {
                    en: enName,
                    ar: arName
                };
                
                saveCustomData();
                updateLocationDropdowns();
                loadLocationsList();
                showToast('location_added');
                
                // Reset form
                this.reset();
            });
            
            // Add risk type form
            document.getElementById('add-risk-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const locationKey = document.getElementById('risk-location-select').value;
                const enRisk = document.getElementById('risk-en').value.trim();
                const arRisk = document.getElementById('risk-ar').value.trim();
                
                if (!locationKey || !enRisk || !arRisk) {
                    showToast('fill_required_fields');
                    return;
                }
                
                if (!customRiskTypes[locationKey]) {
                    customRiskTypes[locationKey] = {};
                }
                
                const riskKey = enRisk.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                
                customRiskTypes[locationKey][riskKey] = {
                    en: enRisk,
                    ar: arRisk
                };
                
                saveCustomData();
                loadRisksList();
                showToast('risk_type_added');
                
                // Reset form
                this.reset();
            });
        }
        
        function loadLocationsList() {
            const locationsList = document.getElementById('locations-list');
            const existingHeader = locationsList.querySelector('h4');
            locationsList.innerHTML = '';
            
            if (existingHeader) {
                locationsList.appendChild(existingHeader);
            }
            
            // Show default locations
            const defaultLocations = getDefaultLocations();
            Object.keys(defaultLocations).forEach(key => {
                const location = defaultLocations[key];
                const div = document.createElement('div');
                div.className = 'p-2 bg-gray-100 dark:bg-gray-700 rounded text-sm';
                div.innerHTML = `
                    <strong>${location.en}</strong> / ${location.ar}
                    <span class="text-xs text-gray-500 dark:text-gray-400 block">Default</span>
                `;
                locationsList.appendChild(div);
            });
            
            // Show custom locations
            Object.keys(customLocations).forEach(key => {
                const location = customLocations[key];
                const div = document.createElement('div');
                div.className = 'p-2 bg-blue-100 dark:bg-blue-900 rounded text-sm';
                div.innerHTML = `
                    <strong>${location.en}</strong> / ${location.ar}
                    <span class="text-xs text-gray-500 dark:text-gray-400 block">Custom</span>
                `;
                locationsList.appendChild(div);
            });
        }
        
        function loadRisksList() {
            const risksList = document.getElementById('risks-list');
            const existingHeader = risksList.querySelector('h4');
            risksList.innerHTML = '';
            
            if (existingHeader) {
                risksList.appendChild(existingHeader);
            }
            
            // Show default risks
            const defaultRisks = getRisksByLocation();
            Object.keys(defaultRisks).forEach(locationKey => {
                const locationName = getLocationName(locationKey);
                const risks = defaultRisks[locationKey];
                
                const locationDiv = document.createElement('div');
                locationDiv.className = 'mb-3';
                locationDiv.innerHTML = `
                    <h5 class="font-medium text-sm mb-2">${locationName}</h5>
                    <div class="space-y-1 ml-3">
                        ${risks.map(risk => `
                            <div class="text-xs p-1 bg-gray-100 dark:bg-gray-700 rounded">
                                ${risk} <span class="text-gray-500">(Default)</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                risksList.appendChild(locationDiv);
            });
            
            // Show custom risks
            Object.keys(customRiskTypes).forEach(locationKey => {
                const locationName = getLocationName(locationKey);
                const risks = customRiskTypes[locationKey];
                
                const locationDiv = document.createElement('div');
                locationDiv.className = 'mb-3';
                locationDiv.innerHTML = `
                    <h5 class="font-medium text-sm mb-2">${locationName}</h5>
                    <div class="space-y-1 ml-3">
                        ${Object.keys(risks).map(riskKey => {
                            const risk = risks[riskKey];
                            return `
                                <div class="text-xs p-1 bg-blue-100 dark:bg-blue-900 rounded">
                                    ${risk.en} / ${risk.ar} <span class="text-gray-500">(Custom)</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                risksList.appendChild(locationDiv);
            });
        }
        
        function getLocationName(locationKey) {
            const allLocations = { ...getDefaultLocations(), ...customLocations };
            const location = allLocations[locationKey];
            return location ? (location[currentLanguage] || location['en']) : locationKey;
        }
        
        // Setup authentication UI
        function setupAuth() {
            const loginButton = document.getElementById('login-button');
            const logoutButton = document.getElementById('logout-button');
            const authContainer = document.getElementById('auth-container');
            const authForm = document.getElementById('auth-form');
            const authTitle = document.getElementById('auth-title');
            const authSubmit = document.getElementById('auth-submit');
            const authSwitch = document.getElementById('auth-switch');
            const authError = document.getElementById('auth-error');
            const closeAuth = document.getElementById('close-auth');
            
            let isLogin = true;
            
            // Login button
            loginButton.addEventListener('click', function() {
                authContainer.classList.remove('hidden');
                authTitle.textContent = t('login');
                authSubmit.textContent = t('login');
                authSwitch.textContent = t('register');
                isLogin = true;
                authError.classList.add('hidden');
            });
            
            // Logout button
            logoutButton.addEventListener('click', function() {
                auth.signOut().catch(error => {
                    console.error("Error signing out: ", error);
                });
            });
            
            // Close auth form
            closeAuth.addEventListener('click', function() {
                authContainer.classList.add('hidden');
            });
            
            // Switch between login and register
            authSwitch.addEventListener('click', function() {
                isLogin = !isLogin;
                authTitle.textContent = t(isLogin ? 'login' : 'register');
                authSubmit.textContent = t(isLogin ? 'login' : 'register');
                authSwitch.textContent = t(isLogin ? 'register' : 'login');
                authError.classList.add('hidden');
            });
            
            // Handle auth form submission
            authForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                if (isLogin) {
                    // Login
                    auth.signInWithEmailAndPassword(email, password)
                        .then(() => {
                            authContainer.classList.add('hidden');
                            authForm.reset();
                            showToast('logged_in_successfully');
                        })
                        .catch(error => {
                            authError.textContent = error.message;
                            authError.classList.remove('hidden');
                        });
                } else {
                    // Register
                    auth.createUserWithEmailAndPassword(email, password)
                        .then(() => {
                            authContainer.classList.add('hidden');
                            authForm.reset();
                            showToast('account_created_successfully');
                        })
                        .catch(error => {
                            authError.textContent = error.message;
                            authError.classList.remove('hidden');
                        });
                }
            });
        }
        
        // Load assessments from Firestore
        function loadAssessments() {
            const assessmentList = document.getElementById('assessment-list');
            const noAssessments = document.getElementById('no-assessments');
            const loadingAssessments = document.getElementById('loading-assessments');
            const exportExcelButton = document.getElementById('export-excel');
            const exportPdfButton = document.getElementById('export-pdf');
            const printPdfButton = document.getElementById('print-pdf');
            const tableContainer = document.getElementById('assessment-table-container');
            const indexErrorContainer = document.getElementById('index-error-container');
            
            // Hide error container if visible
            indexErrorContainer.classList.add('hidden');
            
            // Show loading
            tableContainer.classList.add('hidden');
            noAssessments.classList.add('hidden');
            loadingAssessments.classList.remove('hidden');
            
            // Get the selected date
            const selectedDate = document.getElementById('assessment-date').value;
            
            // Get assessments for the selected date without ordering
            db.collection('assessments')
                .where('assessmentDate', '==', selectedDate)
                .get()
                .then(querySnapshot => {
                    // Clear existing assessments
                    assessmentList.innerHTML = '';
                    
                    // Check if there are any assessments
                    if (querySnapshot.empty) {
                        noAssessments.classList.remove('hidden');
                        loadingAssessments.classList.add('hidden');
                        exportExcelButton.setAttribute('disabled', 'true');
                        exportPdfButton.setAttribute('disabled', 'true');
                        printPdfButton.setAttribute('disabled', 'true');
                        return;
                    }
                    
                    // Enable export buttons
                    exportExcelButton.removeAttribute('disabled');
                    exportPdfButton.removeAttribute('disabled');
                    printPdfButton.removeAttribute('disabled');
                    
                    // Sort documents manually by timestamp (descending)
                    const sortedDocs = querySnapshot.docs.slice();
                    sortedDocs.sort((a, b) => {
                        const timestampA = a.data().timestamp;
                        const timestampB = b.data().timestamp;
                        
                        // Handle missing timestamps or pending server timestamps
                        if (!timestampA) return -1;
                        if (!timestampB) return 1;
                        
                        return timestampB.seconds - timestampA.seconds || 
                               timestampB.nanoseconds - timestampA.nanoseconds;
                    });
                    
                    // Display sorted assessments
                    sortedDocs.forEach(doc => {
                        const data = doc.data();
                        displayAssessmentRow(doc.id, data);
                    });
                    
                    // Hide loading, show assessment table
                    loadingAssessments.classList.add('hidden');
                    tableContainer.classList.remove('hidden');
                })
                .catch(error => {
                    console.error("Error loading assessments: ", error);
                    
                    // Check if it's an index error
                    const indexUrl = extractIndexUrl(error.message);
                    if (indexUrl) {
                        // Show index error instructions
                        document.getElementById('index-link').href = indexUrl;
                        indexErrorContainer.classList.remove('hidden');
                        loadingAssessments.classList.add('hidden');
                    } else {
                        // Show general error
                        noAssessments.textContent = "Error loading assessments: " + error.message;
                        noAssessments.classList.remove('hidden');
                        loadingAssessments.classList.add('hidden');
                    }
                });
        }
        
        // Display a single assessment row
        function displayAssessmentRow(id, assessment) {
            const assessmentList = document.getElementById('assessment-list');
            
            // Create table row
            const row = document.createElement('tr');
            row.className = `fade-in`;
            row.dataset.id = id;
            
            // Format time if timestamp exists
            let formattedTime = currentLanguage === 'ar' ? 'الآن' : 'Just now';
            if (assessment.timestamp) {
                const date = assessment.timestamp.toDate();
                formattedTime = formatTime(date);
            }
            
            // Create affected people chips
            const affectedLabels = getAffectedLabels();
            const affectedChips = assessment.affected.map(person => 
                `<span class="chip chip-${person}">${affectedLabels[person]}</span>`
            ).join('');
            
            // Risk level display with appropriate styling
            const riskLevelHtml = `<span class="risk-badge risk-badge-${assessment.riskLevel}">
                ${t(assessment.riskLevel)}
            </span>`;
            
            // Build table cell HTML
            row.innerHTML = `
                <td class="font-medium">${assessment.location}</td>
                <td>
                    <div class="max-w-xs">
                        <p class="font-medium text-sm">${assessment.riskType}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${formattedTime}</p>
                    </div>
                </td>
                <td>${riskLevelHtml}</td>
                <td>${affectedChips}</td>
                <td>
                    <div class="max-w-xs">
                        <p class="text-sm">${assessment.mitigation.substring(0, 100)}${assessment.mitigation.length > 100 ? '...' : ''}</p>
                    </div>
                </td>
                <td class="whitespace-nowrap">
                    <button class="view-btn action-btn action-btn-view">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        ${t('view')}
                    </button>
                    <button class="edit-btn action-btn action-btn-edit">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        ${t('edit')}
                    </button>
                    <button class="delete-btn action-btn action-btn-delete">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        ${t('delete')}
                    </button>
                </td>
            `;
            
            // Add view functionality
            row.querySelector('.view-btn').addEventListener('click', function() {
                showAssessmentDetails(assessment);
            });
            
            // Add edit functionality
            row.querySelector('.edit-btn').addEventListener('click', function() {
                showEditAssessment(id, assessment);
            });
            
            // Add delete functionality
            row.querySelector('.delete-btn').addEventListener('click', function() {
                const deleteMessage = currentLanguage === 'ar' ? 
                    'هل أنت متأكد من أنك تريد حذف تقييم المخاطر هذا؟' : 
                    'Are you sure you want to delete this risk assessment?';
                showConfirmDialog('confirm_message', function(confirmed) {
                    if (confirmed) {
                        deleteAssessment(id);
                    }
                });
            });
            
            // Add to table
            assessmentList.appendChild(row);
        }
        
        // Delete an assessment
        function deleteAssessment(id) {
            db.collection('assessments').doc(id).delete()
                .then(() => {
                    const row = document.querySelector(`tr[data-id="${id}"]`);
                    if (row) {
                        row.remove();
                    }
                    
                    // Check if there are any assessments left
                    const assessmentList = document.getElementById('assessment-list');
                    const noAssessments = document.getElementById('no-assessments');
                    const tableContainer = document.getElementById('assessment-table-container');
                    const exportExcelButton = document.getElementById('export-excel');
                    const exportPdfButton = document.getElementById('export-pdf');
                    const printPdfButton = document.getElementById('print-pdf');
                    
                    if (assessmentList.children.length === 0) {
                        noAssessments.classList.remove('hidden');
                        tableContainer.classList.add('hidden');
                        exportExcelButton.setAttribute('disabled', 'true');
                        exportPdfButton.setAttribute('disabled', 'true');
                        printPdfButton.setAttribute('disabled', 'true');
                    }
                    
                    showToast('deleted_successfully');
                })
                .catch(error => {
                    console.error("Error deleting assessment: ", error);
                    const errorMessage = `${currentLanguage === 'ar' ? 'خطأ في حذف التقييم:' : 'Error deleting assessment:'} ${error.message}`;
                    showToast(errorMessage, 5000);
                });
        }
        
        // Search assessments
        function searchAssessments() {
            const dateFrom = document.getElementById('search-date-from').value;
            const dateTo = document.getElementById('search-date-to').value;
            const location = document.getElementById('search-location').value;
            const riskLevel = document.getElementById('search-risk-level').value;
            const affected = document.getElementById('search-affected').value;
            const keyword = document.getElementById('search-keyword').value.toLowerCase();
            
            const assessmentList = document.getElementById('assessment-list');
            const noAssessments = document.getElementById('no-assessments');
            const loadingAssessments = document.getElementById('loading-assessments');
            const tableContainer = document.getElementById('assessment-table-container');
            const indexErrorContainer = document.getElementById('index-error-container');
            
            // Hide error container if visible
            indexErrorContainer.classList.add('hidden');
            
            // Show loading
            tableContainer.classList.add('hidden');
            noAssessments.classList.add('hidden');
            loadingAssessments.classList.remove('hidden');
            
            // Build the base query
            let query = db.collection('assessments');
            
            // Apply filters
            if (dateFrom) {
                query = query.where('assessmentDate', '>=', dateFrom);
            }
            
            if (dateTo) {
                query = query.where('assessmentDate', '<=', dateTo);
            }
            
            if (location) {
                query = query.where('location', '==', location);
            }
            
            if (riskLevel) {
                query = query.where('riskLevel', '==', riskLevel);
            }
            
            // Execute the query without ordering
            query.get()
                .then(querySnapshot => {
                    // Clear existing assessments
                    assessmentList.innerHTML = '';
                    
                    // Client-side filtering
                    let filteredResults = [];
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        let includeDoc = true;
                        
                        // Filter by affected people
                        if (affected && !data.affected.includes(affected)) {
                            includeDoc = false;
                        }
                        
                        // Filter by keyword
                        if (keyword && includeDoc) {
                            const riskTypeMatch = data.riskType.toLowerCase().includes(keyword);
                            const mitigationMatch = data.mitigation.toLowerCase().includes(keyword);
                            const notesMatch = data.notes ? data.notes.toLowerCase().includes(keyword) : false;
                            
                            if (!(riskTypeMatch || mitigationMatch || notesMatch)) {
                                includeDoc = false;
                            }
                        }
                        
                        if (includeDoc) {
                            filteredResults.push({ id: doc.id, data });
                        }
                    });
                    
                    // Sort by timestamp if possible
                    filteredResults.sort((a, b) => {
                        const timestampA = a.data.timestamp;
                        const timestampB = b.data.timestamp;
                        
                        if (!timestampA) return -1;
                        if (!timestampB) return 1;
                        
                        return timestampB.seconds - timestampA.seconds || 
                               timestampB.nanoseconds - timestampA.nanoseconds;
                    });
                    
                    // Check if we have results
                    if (filteredResults.length === 0) {
                        noAssessments.textContent = currentLanguage === 'ar' ? 
                            'لم يتم العثور على تقييمات مخاطر مطابقة.' : 
                            'No matching risk assessments found.';
                        noAssessments.classList.remove('hidden');
                        loadingAssessments.classList.add('hidden');
                        return;
                    }
                    
                    // Display filtered assessments
                    filteredResults.forEach(result => {
                        displayAssessmentRow(result.id, result.data);
                    });
                    
                    // Hide loading, show assessment table
                    loadingAssessments.classList.add('hidden');
                    tableContainer.classList.remove('hidden');
                })
                .catch(error => {
                    console.error("Error searching assessments: ", error);
                    
                    // Check if it's an index error
                    const indexUrl = extractIndexUrl(error.message);
                    if (indexUrl) {
                        // Show index error instructions
                        document.getElementById('index-link').href = indexUrl;
                        indexErrorContainer.classList.remove('hidden');
                        loadingAssessments.classList.add('hidden');
                    } else {
                        // Show general error
                        const errorText = currentLanguage === 'ar' ? 
                            'خطأ في البحث عن التقييمات:' : 
                            'Error searching assessments:';
                        noAssessments.textContent = `${errorText} ${error.message}`;
                        noAssessments.classList.remove('hidden');
                        loadingAssessments.classList.add('hidden');
                    }
                });
        }
        
        // Export assessments to Excel - Fixed version
        function exportToExcel() {
            const selectedDate = document.getElementById('assessment-date').value;
            
            // Query Firestore for assessments on selected date
            db.collection('assessments')
                .where('assessmentDate', '==', selectedDate)
                .get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        showToast('no_assessments_export');
                        return;
                    }
                    
                    // Format date for display
                    const dateParts = selectedDate.split('-');
                    const assessmentDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                    const formattedDate = formatDate(assessmentDate);
                    
                    // Create worksheet data
                    const title = currentLanguage === 'ar' ? 
                        'مدرسة بني ياس الدولية الخاصة - تقييم المخاطر اليومي' : 
                        'Baniyas International School - Daily Risk Assessment';
                    const dateLabel = currentLanguage === 'ar' ? 'التاريخ:' : 'Date:';
                    
                    const headers = [
                        t('location'),
                        t('risk_type'),
                        t('risk_level'),
                        t('affected_people'),
                        t('mitigation_strategy'),
                        t('additional_notes'),
                        currentLanguage === 'ar' ? 'الوقت' : 'Time',
                        currentLanguage === 'ar' ? 'أُنشئ بواسطة' : 'Created By'
                    ];
                    
                    const worksheet = [
                        [title],
                        [dateLabel, formattedDate],
                        [''],
                        headers
                    ];
                    
                    // Sort documents by timestamp if possible
                    const sortedDocs = querySnapshot.docs.slice();
                    sortedDocs.sort((a, b) => {
                        const timestampA = a.data().timestamp;
                        const timestampB = b.data().timestamp;
                        
                        if (!timestampA) return -1;
                        if (!timestampB) return 1;
                        
                        return timestampB.seconds - timestampA.seconds || 
                               timestampB.nanoseconds - timestampA.nanoseconds;
                    });
                    
                    // Add assessments to worksheet
                    const affectedLabels = getAffectedLabels();
                    sortedDocs.forEach(doc => {
                        const data = doc.data();
                        let formattedTime = currentLanguage === 'ar' ? 'الآن' : 'Just now';
                        
                        if (data.timestamp) {
                            const date = data.timestamp.toDate();
                            formattedTime = formatTime(date);
                        }
                        
                        worksheet.push([
                            data.location,
                            data.riskType,
                            t(data.riskLevel),
                            data.affected.map(a => affectedLabels[a]).join(', '),
                            data.mitigation,
                            data.notes || '',
                            formattedTime,
                            data.createdByEmail || (currentLanguage === 'ar' ? 'مجهول' : 'Anonymous')
                        ]);
                    });
                    
                    // Create a workbook
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(worksheet);
                    
                    // Set column widths
                    const colWidths = [
                        { wch: 20 }, // Location
                        { wch: 30 }, // Risk Type
                        { wch: 12 }, // Risk Level
                        { wch: 20 }, // Affected People
                        { wch: 40 }, // Mitigation Strategy
                        { wch: 30 }, // Notes
                        { wch: 12 }, // Time
                        { wch: 25 }  // Created By
                    ];
                    ws['!cols'] = colWidths;
                    
                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, currentLanguage === 'ar' ? 'تقييم المخاطر' : 'Risk Assessment');
                    
                    // Export to Excel file
                    try {
                        // Generate Excel file as array buffer
                        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                        
                        // Convert to Blob
                        const blob = new Blob([wbout], { type: 'application/octet-stream' });
                        
                        // Create filename
                        const fileName = `Risk_Assessment_${selectedDate}.xlsx`;
                        
                        // Use FileSaver.js to save the file
                        saveAs(blob, fileName);
                        
                        showToast('excel_downloaded');
                    } catch (e) {
                        console.error('Error during Excel export:', e);
                        const errorMessage = `${currentLanguage === 'ar' ? 'خطأ في تصدير Excel:' : 'Error exporting to Excel:'} ${e.message}`;
                        showToast(errorMessage, 5000);
                    }
                })
                .catch(error => {
                    console.error("Error exporting to Excel: ", error);
                    const errorMessage = `${currentLanguage === 'ar' ? 'خطأ في تصدير Excel:' : 'Error exporting to Excel:'} ${error.message}`;
                    showToast(errorMessage, 5000);
                });
        }
    </script>
</body>
</html>
